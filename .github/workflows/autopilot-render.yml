name: Autopilot Render Watcher

on:
  workflow_dispatch:
    inputs:
      serviceId:
        description: "Render Service ID"
        required: false
      deployId:
        description: "Optional: Render Deploy ID to watch (otherwise latest)"
        required: false
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'src/**'
      - 'package.json'
      - 'render.yaml'

jobs:
  watch-render:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[watch-render]'))
    
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: 📦 Install dependencies
        run: npm ci || echo "No package-lock.json, skipping npm ci"

      - name: 🔍 Run Render Watcher
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ github.event.inputs.serviceId || secrets.RENDER_SERVICE_ID }}
          RENDER_DEPLOY_ID: ${{ github.event.inputs.deployId }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node scripts/render/poll-render.js

      - name: ✅ Deployment Success
        if: success()
        run: |
          echo "🎉 Render deployment completed successfully!"
          echo "🔗 Check your service at: https://dashboard.render.com"

      - name: ❌ Deployment Failed
        if: failure()
        run: |
          echo "❌ Render deployment failed"
          echo "📝 Check the GitHub Issue created for details"
          echo "🔗 Render Dashboard: https://dashboard.render.com"
