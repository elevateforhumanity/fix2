name: Autopilot - Sync Netlify & Vercel Environments

on:
  workflow_dispatch:
    inputs:
      trigger_deploys:
        description: 'Trigger production deploys on both platforms'
        type: boolean
        default: false
  
  # Optional: Auto-sync when secrets are updated
  # schedule:
  #   - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

jobs:
  sync-platforms:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make script executable
        run: chmod +x scripts/autopilot-sync-platforms.sh

      - name: Sync environment variables
        env:
          # Vercel credentials
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

          # Netlify credentials
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

          # Application URLs
          APP_URL: "https://elevateconnectsdirectory.org"

          # Supabase
          SUPABASE_URL: "https://cuxzzpsyufcewtmicszk.supabase.co"
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          # Optional integrations
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

          # PWA / Push Notifications
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}

          # AWS / S3
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}

          # AI Features
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          ./scripts/autopilot-sync-platforms.sh

      - name: Trigger Vercel Deploy
        if: ${{ inputs.trigger_deploys == true }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸš€ Triggering Vercel production deploy..."
          npx vercel --prod --token "$VERCEL_TOKEN" --yes

      - name: Trigger Netlify Deploy
        if: ${{ inputs.trigger_deploys == true }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "ðŸš€ Triggering Netlify production deploy..."
          npx netlify-cli deploy --prod --auth "$NETLIFY_AUTH_TOKEN" --site "$NETLIFY_SITE_ID"

      - name: Summary
        run: |
          echo "## âœ… Platform Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment variables have been synchronized between:" >> $GITHUB_STEP_SUMMARY
          echo "- **Vercel** (Production, Preview, Development)" >> $GITHUB_STEP_SUMMARY
          echo "- **Netlify** (Production, Deploy Preview, Branch Deploy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploys Triggered:** ${{ inputs.trigger_deploys }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both platforms now have identical configuration." >> $GITHUB_STEP_SUMMARY
