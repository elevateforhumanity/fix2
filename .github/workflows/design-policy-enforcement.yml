name: Design Policy Enforcement

on:
  pull_request:
    paths:
      - 'app/**/*.tsx'
      - 'components/**/*.tsx'
  push:
    branches:
      - main
    paths:
      - 'app/**/*.tsx'
      - 'components/**/*.tsx'

jobs:
  enforce-design-policy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for Heavy Overlays
        id: check-overlays
        run: |
          echo "üîç Checking for prohibited heavy overlays..."
          
          # Find heavy overlays (50%+) excluding gradients and UI elements
          VIOLATIONS=$(grep -r "bg-black/[5-9][0-9]\|bg-.*-900/[5-9][0-9]" app components --include="*.tsx" | \
            grep -v "node_modules" | \
            grep -v "bg-gradient" | \
            grep -v "fixed inset-0" | \
            grep -v "modal" | \
            grep -v "sidebar" || true)
          
          if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå POLICY VIOLATION: Heavy overlays detected"
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "POLICY: Heavy overlays (50%+ opacity) are prohibited on content."
            echo ""
            echo "ALLOWED:"
            echo "  ‚úÖ bg-black/40 (max) for hero sections"
            echo "  ‚úÖ bg-gradient-to-t from-color-900/90 to-transparent for photo cards"
            echo ""
            echo "PROHIBITED:"
            echo "  ‚ùå bg-black/50, bg-black/60, bg-black/70"
            echo "  ‚ùå bg-blue-900/70, bg-purple-900/70, etc."
            echo ""
            echo "WHY: We have real photos of real students. Heavy overlays hide them."
            echo ""
            echo "FIX: Run ./scripts/enforce-design-policy.sh"
            exit 1
          fi
          
          echo "‚úÖ No heavy overlay violations found"
      
      - name: Check for Placeholder Images
        id: check-placeholders
        run: |
          echo "üîç Checking for placeholder images..."
          
          # Find placeholder image references
          VIOLATIONS=$(grep -r "src=.*placeholder\|src=.*generic.*\\.jpg\|src=.*stock-photo" app components --include="*.tsx" | \
            grep -v "node_modules" | \
            grep -v "placeholder=" || true)
          
          if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå POLICY VIOLATION: Placeholder images detected"
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "POLICY: Placeholder and generic images are prohibited."
            echo ""
            echo "REQUIRED:"
            echo "  ‚úÖ Use real photos from /public/images/"
            echo "  ‚úÖ Use real videos from /public/videos/"
            echo ""
            echo "PROHIBITED:"
            echo "  ‚ùå placeholder.jpg, generic-student.jpg, stock-photo.jpg"
            echo "  ‚ùå via.placeholder.com, placeholder.com"
            echo ""
            echo "WHY: We have 724 real images. Use them."
            exit 1
          fi
          
          echo "‚úÖ No placeholder image violations found"
      
      - name: Check for External Placeholder Services
        id: check-external
        run: |
          echo "üîç Checking for external placeholder services..."
          
          VIOLATIONS=$(grep -r "via.placeholder.com\|placeholder.com\|lorempixel.com\|unsplash.it" app components --include="*.tsx" | \
            grep -v "node_modules" || true)
          
          if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå POLICY VIOLATION: External placeholder service detected"
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "POLICY: External placeholder services are prohibited."
            echo ""
            echo "USE: Real photos from /public/images/"
            exit 1
          fi
          
          echo "‚úÖ No external placeholder violations found"
      
      - name: Verify Hero Videos
        id: check-videos
        run: |
          echo "üîç Verifying hero video placements..."
          
          # Check programs page
          if ! grep -q "programs-overview-video\|hero.*video" app/programs/page.tsx; then
            echo "‚ö†Ô∏è  WARNING: Programs page may be missing hero video"
          else
            echo "‚úÖ Programs page has hero video"
          fi
          
          # Check employer page
          if ! grep -q "employer-partner-hero\|hero.*video" app/employer/page.tsx; then
            echo "‚ö†Ô∏è  WARNING: Employer page may be missing hero video"
          else
            echo "‚úÖ Employer page has hero video"
          fi
          
          # Check homepage
          if ! grep -q "hero-home.mp4\|hero.*video" app/page.tsx; then
            echo "‚ö†Ô∏è  WARNING: Homepage may be missing hero video"
          else
            echo "‚úÖ Homepage has hero video"
          fi
      
      - name: Policy Check Summary
        if: success()
        run: |
          echo "‚úÖ All design policy checks passed"
          echo ""
          echo "Policy enforced:"
          echo "  ‚úÖ No heavy overlays (50%+ opacity)"
          echo "  ‚úÖ No placeholder images"
          echo "  ‚úÖ No external placeholder services"
          echo "  ‚úÖ Hero videos verified"
          echo ""
          echo "Site is compliant with design policy."
