name: Durable Bridge Auto-Deploy

on:
  push:
    paths:
      - 'bridge/**'
      - 'scripts/deploy-durable-bridge.sh'
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: 'false'

jobs:
  deploy-bridge:
    runs-on: ubuntu-latest
    name: Deploy Durable Bridge
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Copy bridge files to public
        run: |
          mkdir -p public/api
          cp -f bridge/public/efh-bridge.js public/
          cp -f bridge/api/efh-config.json public/api/
          echo "âœ… Bridge files copied to public/"

      - name: Build project
        run: pnpm build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Verify bridge files in dist
        run: |
          if [ -f "dist/efh-bridge.js" ]; then
            echo "âœ… efh-bridge.js found in dist"
            ls -lh dist/efh-bridge.js
          else
            echo "âš ï¸ efh-bridge.js not in dist, checking public"
            ls -lh public/efh-bridge.js
          fi
          
          if [ -f "dist/api/efh-config.json" ]; then
            echo "âœ… efh-config.json found in dist"
            ls -lh dist/api/efh-config.json
          else
            echo "âš ï¸ efh-config.json not in dist, checking public"
            ls -lh public/api/efh-config.json
          fi

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy Durable bridge - ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Verify deployment
        run: |
          echo "â³ Waiting for deployment to propagate..."
          sleep 10
          
          echo "ðŸ” Verifying bridge script..."
          curl -I https://elevateforhumanityfix2.netlify.app/efh-bridge.js || echo "âš ï¸ Bridge script not yet available"
          
          echo "ðŸ” Verifying config..."
          curl -I https://elevateforhumanityfix2.netlify.app/api/efh-config.json || echo "âš ï¸ Config not yet available"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Durable Bridge Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bridge deployed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Durable Setup (One-Time)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add this script to your Durable.co site:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```html' >> $GITHUB_STEP_SUMMARY
          echo '<script' >> $GITHUB_STEP_SUMMARY
          echo '  src="https://elevateforhumanityfix2.netlify.app/efh-bridge.js"' >> $GITHUB_STEP_SUMMARY
          echo '  data-efh-org="elevate-for-humanity"' >> $GITHUB_STEP_SUMMARY
          echo '  data-env="prod"' >> $GITHUB_STEP_SUMMARY
          echo '  defer></script>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Add Content Slots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```html' >> $GITHUB_STEP_SUMMARY
          echo '<div data-efh-slot="hero"></div>' >> $GITHUB_STEP_SUMMARY
          echo '<div data-efh-slot="programs"></div>' >> $GITHUB_STEP_SUMMARY
          echo '<div data-efh-slot="features"></div>' >> $GITHUB_STEP_SUMMARY
          echo '<div data-efh-slot="testimonials"></div>' >> $GITHUB_STEP_SUMMARY
          echo '<div data-efh-slot="cta"></div>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Future Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Edit \`bridge/api/efh-config.json\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit and push" >> $GITHUB_STEP_SUMMARY
          echo "3. This workflow auto-deploys" >> $GITHUB_STEP_SUMMARY
          echo "4. Changes appear on Durable instantly!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Verify:** [Bridge Script](https://elevateforhumanityfix2.netlify.app/efh-bridge.js) | [Config](https://elevateforhumanityfix2.netlify.app/api/efh-config.json)" >> $GITHUB_STEP_SUMMARY
