name: Autopilot â€“ Deployment Target Bouncer

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - 'vercel.json'
      - '.vercel/**'
      - '.github/workflows/**'

jobs:
  check-deployment-targets:
    name: Verify Only Netlify is Configured
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Vercel configuration files
        id: check-vercel
        run: |
          echo "# ðŸš« Deployment Target Protection" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Checking for Unauthorized Deployment Configurations" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          found_issues=0

          # Check for vercel.json
          if [ -f "vercel.json" ]; then
            echo "âŒ **Found**: \`vercel.json\`" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ This file configures Vercel deployment" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ **Action**: Delete this file - Netlify is the only allowed deployment target" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            found_issues=$((found_issues+1))
          else
            echo "âœ… No \`vercel.json\` found" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Check for .vercel directory
          if [ -d ".vercel" ]; then
            echo "âŒ **Found**: \`.vercel/\` directory" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ This directory contains Vercel project configuration" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ **Action**: Delete this directory and add to .gitignore" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            found_issues=$((found_issues+1))
          else
            echo "âœ… No \`.vercel/\` directory found" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Check for Vercel references in GitHub Actions workflows
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Checking GitHub Actions Workflows" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -d ".github/workflows" ]; then
            VERCEL_WORKFLOWS=$(grep -r "vercel" .github/workflows/ --include="*.yml" --include="*.yaml" -l 2>/dev/null || true)
            
            if [ -n "$VERCEL_WORKFLOWS" ]; then
              echo "âš ï¸ **Found Vercel references in workflows**:" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
              echo "$VERCEL_WORKFLOWS" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "**Action**: Review these workflows and remove Vercel-specific steps" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              found_issues=$((found_issues+1))
            else
              echo "âœ… No Vercel references in GitHub Actions workflows" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

          # Set output
          echo "issues_found=$found_issues" >> "$GITHUB_OUTPUT"

      - name: Check for Netlify configuration
        id: check-netlify
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## âœ… Netlify Configuration Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          netlify_configured=0

          # Check for netlify.toml
          if [ -f "netlify.toml" ]; then
            echo "âœ… **Found**: \`netlify.toml\` (Netlify configuration file)" >> "$GITHUB_STEP_SUMMARY"
            netlify_configured=1
          fi

          # Check for Netlify workflows
          if [ -d ".github/workflows" ]; then
            NETLIFY_WORKFLOWS=$(grep -r "netlify" .github/workflows/ --include="*.yml" --include="*.yaml" -l 2>/dev/null || true)
            
            if [ -n "$NETLIFY_WORKFLOWS" ]; then
              echo "âœ… **Found Netlify workflows**:" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
              echo "$NETLIFY_WORKFLOWS" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
              netlify_configured=1
            fi
          fi

          if [ "$netlify_configured" -eq 0 ]; then
            echo "â„¹ï¸ No Netlify configuration files found in repository" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Note**: Netlify can deploy without configuration files using dashboard settings" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Primary Deployment**: Netlify (elevateconnectsdirectory.org)" >> "$GITHUB_STEP_SUMMARY"

      - name: Check .gitignore for deployment artifacts
        id: check-gitignore
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“ .gitignore Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f ".gitignore" ]; then
            # Check for .vercel in .gitignore
            if grep -q "^\.vercel" .gitignore || grep -q "^.vercel" .gitignore; then
              echo "âœ… \`.vercel\` is in .gitignore" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ \`.vercel\` is NOT in .gitignore" >> "$GITHUB_STEP_SUMMARY"
              echo "   â†’ **Action**: Add \`.vercel\` to .gitignore to prevent accidental commits" >> "$GITHUB_STEP_SUMMARY"
            fi

            # Check for .netlify in .gitignore
            if grep -q "^\.netlify" .gitignore || grep -q "^.netlify" .gitignore; then
              echo "âœ… \`.netlify\` is in .gitignore" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "â„¹ï¸ \`.netlify\` is NOT in .gitignore (optional but recommended)" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ No .gitignore file found" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Summary and recommendations
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“Š Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.check-vercel.outputs.issues_found }}" -gt 0 ]; then
            echo "âŒ **Status**: Found ${{ steps.check-vercel.outputs.issues_found }} unauthorized deployment configuration(s)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Required Actions" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "1. Remove all Vercel configuration files listed above" >> "$GITHUB_STEP_SUMMARY"
            echo "2. Add \`.vercel\` to .gitignore" >> "$GITHUB_STEP_SUMMARY"
            echo "3. Disconnect Vercel integration from GitHub repository (if connected)" >> "$GITHUB_STEP_SUMMARY"
            echo "4. Re-run this workflow to verify cleanup" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### How to Disconnect Vercel" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "1. Go to: https://vercel.com/dashboard" >> "$GITHUB_STEP_SUMMARY"
            echo "2. Find your project" >> "$GITHUB_STEP_SUMMARY"
            echo "3. Settings â†’ Git â†’ Disconnect" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âœ… **Status**: No unauthorized deployment configurations found" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Deployment Target**: Netlify only (as required)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Production URL**: https://elevateconnectsdirectory.org" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ¤– *Deployment Bouncer completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if unauthorized configs found
        if: steps.check-vercel.outputs.issues_found != '0'
        run: |
          echo "::error::Found ${{ steps.check-vercel.outputs.issues_found }} unauthorized deployment configuration(s). Remove Vercel files before deploying."
          exit 1

      - name: Success notification
        if: steps.check-vercel.outputs.issues_found == '0'
        run: |
          echo "âœ… Deployment target protection passed - only Netlify is configured."
