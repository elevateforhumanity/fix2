name: Setup Supabase Keys (Autopilot)

on:
  workflow_dispatch:
    inputs:
      supabase_password:
        description: 'Supabase Project Password (if needed)'
        required: false
        type: string

jobs:
  setup-keys:
    name: Retrieve and Configure Supabase Keys
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Supabase CLI
        run: |
          npm install -g supabase
          echo "âœ… Supabase CLI installed"
      
      - name: Check Supabase Project Status
        id: check-project
        run: |
          echo "ğŸ” Checking Supabase project: https://cuxzzpsyufcewtmicszk.supabase.co"
          
          # Test if project is accessible
          response=$(curl -s -o /dev/null -w "%{http_code}" https://cuxzzpsyufcewtmicszk.supabase.co)
          
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… Supabase project is accessible"
            echo "project_accessible=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Supabase project returned status: $response"
            echo "project_accessible=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract Project Reference
        id: extract-ref
        run: |
          PROJECT_REF="cuxzzpsyufcewtmicszk"
          echo "project_ref=$PROJECT_REF" >> $GITHUB_OUTPUT
          echo "âœ… Project Reference: $PROJECT_REF"
      
      - name: Get Supabase Keys from GitHub Secrets
        id: get-keys
        run: |
          echo "ğŸ” Checking for Supabase keys in GitHub Secrets..."
          
          if [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "âœ… SUPABASE_ANON_KEY found in secrets"
            echo "anon_key_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ SUPABASE_ANON_KEY not found in secrets"
            echo "anon_key_exists=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "âœ… SUPABASE_SERVICE_ROLE_KEY found in secrets"
            echo "service_key_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ SUPABASE_SERVICE_ROLE_KEY not found in secrets"
            echo "service_key_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Environment File
        if: steps.get-keys.outputs.anon_key_exists == 'true' && steps.get-keys.outputs.service_key_exists == 'true'
        run: |
          echo "ğŸ“ Creating .env.local file..."
          
          cat > .env.local << EOF
          # Supabase Configuration (Auto-generated by GitHub Actions)
          NEXT_PUBLIC_SUPABASE_URL=https://cuxzzpsyufcewtmicszk.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
          # Site Configuration
          NEXT_PUBLIC_SITE_URL=https://elevateconnectsdirectory.org
          NEXT_PUBLIC_APP_URL=https://elevateconnectsdirectory.org
          
          # Email Configuration (Optional)
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          EMAIL_FROM=noreply@elevateconnectsdirectory.org
          
          # Stripe Configuration (Optional)
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          EOF
          
          echo "âœ… .env.local created successfully"
      
      - name: Verify Configuration
        if: steps.get-keys.outputs.anon_key_exists == 'true'
        run: |
          echo "ğŸ§ª Verifying Supabase configuration..."
          
          # Test connection
          npm install @supabase/supabase-js
          
          node << 'VERIFY_SCRIPT'
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = 'https://cuxzzpsyufcewtmicszk.supabase.co';
          const supabaseKey = process.env.SUPABASE_ANON_KEY || '${{ secrets.SUPABASE_ANON_KEY }}';
          
          if (!supabaseKey || supabaseKey.includes('secrets.')) {
            console.log('âš ï¸ Anon key not available for testing');
            process.exit(0);
          }
          
          try {
            const supabase = createClient(supabaseUrl, supabaseKey);
            console.log('âœ… Supabase client created successfully');
            console.log('âœ… Configuration is valid');
          } catch (error) {
            console.error('âŒ Error creating Supabase client:', error.message);
            process.exit(1);
          }
          VERIFY_SCRIPT
      
      - name: Instructions for Missing Keys
        if: steps.get-keys.outputs.anon_key_exists == 'false' || steps.get-keys.outputs.service_key_exists == 'false'
        run: |
          echo "âš ï¸ ============================================"
          echo "âš ï¸ SUPABASE KEYS NOT FOUND IN GITHUB SECRETS"
          echo "âš ï¸ ============================================"
          echo ""
          echo "ğŸ“‹ TO FIX THIS, ADD THE FOLLOWING SECRETS:"
          echo ""
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo ""
          echo "2. Click 'New repository secret' and add:"
          echo ""
          echo "   Name: SUPABASE_ANON_KEY"
          echo "   Value: Get from https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk/settings/api"
          echo "   (Copy the 'anon public' key)"
          echo ""
          echo "   Name: SUPABASE_SERVICE_ROLE_KEY"
          echo "   Value: Get from https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk/settings/api"
          echo "   (Copy the 'service_role' key - keep this secret!)"
          echo ""
          echo "3. Optional secrets (for full functionality):"
          echo "   - RESEND_API_KEY (for email notifications)"
          echo "   - STRIPE_SECRET_KEY (for payments)"
          echo "   - STRIPE_PUBLISHABLE_KEY (for payments)"
          echo "   - STRIPE_WEBHOOK_SECRET (for payment webhooks)"
          echo ""
          echo "4. After adding secrets, re-run this workflow"
          echo ""
          echo "ğŸ“– Full guide: https://github.com/${{ github.repository }}/blob/main/SUPABASE_SETUP_GUIDE.md"
          
          exit 1
      
      - name: Update Netlify Environment Variables
        if: steps.get-keys.outputs.anon_key_exists == 'true' && steps.get-keys.outputs.service_key_exists == 'true'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          if [ -z "$NETLIFY_AUTH_TOKEN" ] || [ -z "$NETLIFY_SITE_ID" ]; then
            echo "âš ï¸ Netlify credentials not found, skipping Netlify update"
            exit 0
          fi
          
          echo "ğŸ”§ Updating Netlify environment variables..."
          
          npm install -g netlify-cli
          
          # Update Netlify env vars
          netlify env:set NEXT_PUBLIC_SUPABASE_URL "https://cuxzzpsyufcewtmicszk.supabase.co" --site $NETLIFY_SITE_ID
          netlify env:set NEXT_PUBLIC_SUPABASE_ANON_KEY "${{ secrets.SUPABASE_ANON_KEY }}" --site $NETLIFY_SITE_ID
          netlify env:set SUPABASE_SERVICE_ROLE_KEY "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" --site $NETLIFY_SITE_ID
          netlify env:set NEXT_PUBLIC_SITE_URL "https://elevateconnectsdirectory.org" --site $NETLIFY_SITE_ID
          
          echo "âœ… Netlify environment variables updated"
      
      - name: Create Setup Summary
        if: always()
        run: |
          echo "# ğŸ”§ Supabase Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Project URL**: https://cuxzzpsyufcewtmicszk.supabase.co" >> $GITHUB_STEP_SUMMARY
          echo "- **Project Reference**: cuxzzpsyufcewtmicszk" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard**: https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.get-keys.outputs.anon_key_exists }}" = "true" ]; then
            echo "âœ… **Anon Key**: Configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Anon Key**: Missing - [Add it here](https://github.com/${{ github.repository }}/settings/secrets/actions)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.get-keys.outputs.service_key_exists }}" = "true" ]; then
            echo "âœ… **Service Role Key**: Configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Service Role Key**: Missing - [Add it here](https://github.com/${{ github.repository }}/settings/secrets/actions)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.get-keys.outputs.anon_key_exists }}" = "true" ] && [ "${{ steps.get-keys.outputs.service_key_exists }}" = "true" ]; then
            echo "âœ… All keys configured! The application is ready to use." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Local Development" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Pull the latest changes" >> $GITHUB_STEP_SUMMARY
            echo "git pull" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# The .env.local file has been created" >> $GITHUB_STEP_SUMMARY
            echo "# Start the development server" >> $GITHUB_STEP_SUMMARY
            echo "npm run dev" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Action Required**: Add missing secrets to continue" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Visit [Supabase Dashboard](https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk/settings/api)" >> $GITHUB_STEP_SUMMARY
            echo "2. Copy the API keys" >> $GITHUB_STEP_SUMMARY
            echo "3. Add them to [GitHub Secrets](https://github.com/${{ github.repository }}/settings/secrets/actions)" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resources" >> $GITHUB_STEP_SUMMARY
          echo "- [Setup Guide](https://github.com/${{ github.repository }}/blob/main/SUPABASE_SETUP_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Supabase Dashboard](https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Settings](https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk/settings/api)" >> $GITHUB_STEP_SUMMARY
      
      - name: Success Message
        if: steps.get-keys.outputs.anon_key_exists == 'true' && steps.get-keys.outputs.service_key_exists == 'true'
        run: |
          echo "ğŸ‰ ================================"
          echo "ğŸ‰ SUPABASE SETUP COMPLETE!"
          echo "ğŸ‰ ================================"
          echo ""
          echo "âœ… Project URL: https://cuxzzpsyufcewtmicszk.supabase.co"
          echo "âœ… Anon Key: Configured"
          echo "âœ… Service Role Key: Configured"
          echo "âœ… Environment file: Created"
          echo ""
          echo "ğŸš€ The application is ready to use!"
          echo ""
          echo "ğŸ“ Next steps:"
          echo "1. Pull the latest changes: git pull"
          echo "2. Start development server: npm run dev"
          echo "3. Visit: http://localhost:3000"
