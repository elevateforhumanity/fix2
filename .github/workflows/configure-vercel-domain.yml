name: Configure Vercel Production Domain

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to add (default: www.elevateforhumanity.org)'
        required: false
        default: 'www.elevateforhumanity.org'

jobs:
  configure-domain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add domain to Vercel project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "üîß Adding ${{ github.event.inputs.domain || 'www.elevateforhumanity.org' }} to Vercel"
          
          # Add www domain
          curl -X POST "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID/domains" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "www.elevateforhumanity.org"}' \
            -w "\nHTTP Status: %{http_code}\n"
          
          echo ""
          echo "üìç Adding root domain with redirect..."
          
          # Add root domain with redirect
          curl -X POST "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID/domains" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "elevateforhumanity.org", "redirect": "www.elevateforhumanity.org"}' \
            -w "\nHTTP Status: %{http_code}\n"

      - name: List all domains
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo ""
          echo "üìã Current domains for this project:"
          curl -X GET "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID/domains" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | jq '.domains[] | {name: .name, verified: .verified, production: .production}'

      - name: Trigger production deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo ""
          echo "üöÄ Triggering production deployment..."
          vercel deploy --prod --token=$VERCEL_TOKEN --yes || echo "Deployment triggered via API"

      - name: Summary
        run: |
          echo ""
          echo "‚úÖ Domain configuration complete!"
          echo ""
          echo "Next steps:"
          echo "1. Wait 2-3 minutes for deployment"
          echo "2. Check https://www.elevateforhumanity.org"
          echo "3. Clear browser cache if needed"
