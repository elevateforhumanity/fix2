name: Autopilot â€“ Fix Netlify Environment Variables

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: "Force redeploy even if nothing changed"
        required: false
        type: boolean
        default: false

jobs:
  fix-netlify-env:
    name: Check, Correct, and Set Netlify Env Vars
    runs-on: ubuntu-latest

    env:
      # These MUST exist in GitHub repo settings â†’ Secrets â†’ Actions
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required GitHub Secrets
        run: |
          echo "ðŸ” Checking required GitHub Secrets..."

          missing=0

          if [ -z "$NETLIFY_AUTH_TOKEN" ]; then
            echo "âŒ Missing secret: NETLIFY_AUTH_TOKEN"
            missing=1
          fi

          if [ -z "$NETLIFY_SITE_ID" ]; then
            echo "âŒ Missing secret: NETLIFY_SITE_ID"
            missing=1
          fi

          if [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âŒ Missing secret: SUPABASE_ANON_KEY"
            missing=1
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ Missing secret: SUPABASE_SERVICE_ROLE_KEY"
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            echo ""
            echo "âš ï¸ One or more required secrets are missing."
            echo "   Go to: Settings â†’ Secrets and variables â†’ Actions"
            echo "   Add the missing secrets, then re-run this workflow."
            exit 1
          fi

          echo "âœ… All required GitHub Secrets are present."

      - name: Install Netlify CLI
        run: |
          echo "âš™ï¸ Installing Netlify CLI..."
          npm install -g netlify-cli
          echo "âœ… Netlify CLI installed."

      - name: Show Netlify site status
        run: |
          echo "ðŸ“‹ Checking Netlify status for site: $NETLIFY_SITE_ID"
          netlify status --site "$NETLIFY_SITE_ID" || echo "â„¹ï¸ Netlify status command returned a non-zero code (this may be okay if site is new)."

      - name: Fetch current Netlify env vars
        run: |
          echo "ðŸ” Current Netlify environment variables (masked values):"
          netlify env:list --site "$NETLIFY_SITE_ID" || echo "âš ï¸ Could not list env vars (check site ID / auth token)."

      - name: Check and fix critical env vars
        id: fixenv
        run: |
          set -e

          echo "ðŸ›  Ensuring critical environment variables are correct..."

          CORRECT_SUPABASE_URL="https://cuxzzpsyufcewtmicszk.supabase.co"
          CORRECT_APP_URL="https://elevateconnectsdirectory.org"

          fixed_count=0
          created_count=0
          unchanged_count=0

          fix_var () {
            VAR_NAME="$1"
            CORRECT_VALUE="$2"

            echo ""
            echo "ðŸ”Ž Checking $VAR_NAME ..."

            CURRENT_VALUE=$(netlify env:get "$VAR_NAME" --site "$NETLIFY_SITE_ID" 2>/dev/null || echo "")

            if [ -z "$CURRENT_VALUE" ]; then
              echo "âš ï¸ $VAR_NAME is missing â€“ creating..."
              printf "%s" "$CORRECT_VALUE" | netlify env:set "$VAR_NAME" --site "$NETLIFY_SITE_ID" > /dev/null
              echo "âœ… Created $VAR_NAME"
              created_count=$((created_count+1))
            elif [ "$CURRENT_VALUE" != "$CORRECT_VALUE" ]; then
              echo "âŒ $VAR_NAME has incorrect value â€“ fixing..."
              printf "%s" "$CORRECT_VALUE" | netlify env:set "$VAR_NAME" --site "$NETLIFY_SITE_ID" > /dev/null
              echo "âœ… Updated $VAR_NAME"
              fixed_count=$((fixed_count+1))
            else
              echo "âœ… $VAR_NAME is already correct."
              unchanged_count=$((unchanged_count+1))
            fi
          }

          echo "âž¡ï¸ Enforcing Supabase URL..."
          fix_var "NEXT_PUBLIC_SUPABASE_URL" "$CORRECT_SUPABASE_URL"

          echo "âž¡ï¸ Enforcing Supabase anon key from GitHub Secrets..."
          fix_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" "$SUPABASE_ANON_KEY"

          echo "âž¡ï¸ Enforcing Supabase service role key from GitHub Secrets..."
          fix_var "SUPABASE_SERVICE_ROLE_KEY" "$SUPABASE_SERVICE_ROLE_KEY"

          echo "âž¡ï¸ Enforcing site URLs..."
          fix_var "NEXT_PUBLIC_APP_URL" "$CORRECT_APP_URL"
          fix_var "NEXT_PUBLIC_SITE_URL" "$CORRECT_APP_URL"
          fix_var "NEXT_PUBLIC_BASE_URL" "$CORRECT_APP_URL"

          echo "âž¡ï¸ Enforcing NODE_ENV=production..."
          fix_var "NODE_ENV" "production"

          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Created:  $created_count"
          echo "   Updated:  $fixed_count"
          echo "   Unchanged: $unchanged_count"

          # Expose counts to later steps
          echo "created_count=$created_count" >> "$GITHUB_OUTPUT"
          echo "fixed_count=$fixed_count" >> "$GITHUB_OUTPUT"
          echo "unchanged_count=$unchanged_count" >> "$GITHUB_OUTPUT"

      - name: Trigger Netlify redeploy (if needed)
        if: ${{ steps.fixenv.outputs.created_count != '0' || steps.fixenv.outputs.fixed_count != '0' || inputs.force_redeploy == true }}
        run: |
          echo "ðŸš€ Changes detected OR force_redeploy=true â€“ triggering new Netlify deploy..."

          curl -X POST \
            "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds" \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"clear_cache": true}' || {
              echo "âš ï¸ Failed to trigger deploy via API. Check NETLIFY_SITE_ID and NETLIFY_AUTH_TOKEN."
              exit 1
            }

          echo "âœ… Deploy triggered. Monitor at:"
          echo "   https://app.netlify.com/sites/$NETLIFY_SITE_ID/deploys"

      - name: Skip redeploy (no changes)
        if: ${{ steps.fixenv.outputs.created_count == '0' && steps.fixenv.outputs.fixed_count == '0' && inputs.force_redeploy != true }}
        run: |
          echo "â„¹ï¸ No env vars changed and force_redeploy=false â€“ not triggering a new deploy."

      - name: Summary
        if: always()
        run: |
          echo "# ðŸ¤– Autopilot â€“ Netlify Environment Variables" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Status" >> "$GITHUB_STEP_SUMMARY"
          echo "- Created:  ${{ steps.fixenv.outputs.created_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Updated:  ${{ steps.fixenv.outputs.fixed_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Unchanged: ${{ steps.fixenv.outputs.unchanged_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Notes" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source of truth for Supabase URL is hard-coded to your project: https://cuxzzpsyufcewtmicszk.supabase.co" >> "$GITHUB_STEP_SUMMARY"
          echo "- Keys are pulled ONLY from GitHub Secrets and synced into Netlify." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "If the site still shows Internal Server Error after this:" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Check Netlify build logs" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Check Supabase project status" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Confirm DNS points correctly to Netlify" >> "$GITHUB_STEP_SUMMARY"
