name: Nightly-DB-Backup

on:
  schedule:
    - cron: '0 6 * * *' # every day at 06:00 UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      S3_BACKUP_BUCKET: ${{ secrets.S3_BACKUP_BUCKET }}

    steps:
      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client awscli

      - name: Create DB backup
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
          FILE_NAME="db-backup-$TIMESTAMP.sql.gz"
          echo "Creating backup $FILE_NAME"
          pg_dump "$SUPABASE_DB_URL" | gzip > $FILE_NAME
          echo "Uploading to S3"
          aws s3 cp $FILE_NAME s3://$S3_BACKUP_BUCKET/$FILE_NAME

      - name: Cleanup
        run: rm -f db-backup-*.sql.gz

      - name: Notify Slack on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{"text":"✅ Database backup completed successfully"}'

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{"text":"❌ Database backup FAILED - check GitHub Actions logs"}'
