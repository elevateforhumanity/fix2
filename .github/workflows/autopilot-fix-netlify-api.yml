name: Autopilot - Fix Netlify Env (Direct API)

on:
  workflow_dispatch:

jobs:
  fix-env-vars:
    name: Fix Netlify Environment Variables via API
    runs-on: ubuntu-latest
    
    steps:
      - name: Check GitHub Secrets
        run: |
          echo "ðŸ” Checking GitHub Secrets..."
          
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
            echo "âŒ NETLIFY_AUTH_TOKEN missing"
            echo "Get from: https://app.netlify.com/user/applications"
            echo "Add at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
            echo "âŒ NETLIFY_SITE_ID missing"
            echo "Get from: Netlify site settings"
            echo "Add at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          echo "âœ… GitHub Secrets found"
      
      - name: Get Current Netlify Env Vars
        id: get_vars
        run: |
          echo "ðŸ” Fetching current Netlify environment variables..."
          
          RESPONSE=$(curl -s -X GET \
            "https://api.netlify.com/api/v1/accounts/*/env?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}")
          
          echo "Current variables:"
          echo "$RESPONSE" | jq -r '.[] | .key' || echo "Could not parse response"
      
      - name: Set NEXT_PUBLIC_SUPABASE_URL
        run: |
          echo "Setting NEXT_PUBLIC_SUPABASE_URL..."
          
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/NEXT_PUBLIC_SUPABASE_URL?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "context": "all",
              "value": "https://cuxzzpsyufcewtmicszk.supabase.co"
            }'
          
          echo "âœ… Set NEXT_PUBLIC_SUPABASE_URL"
      
      - name: Set NEXT_PUBLIC_SUPABASE_ANON_KEY
        if: ${{ secrets.SUPABASE_ANON_KEY != '' }}
        run: |
          echo "Setting NEXT_PUBLIC_SUPABASE_ANON_KEY..."
          
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/NEXT_PUBLIC_SUPABASE_ANON_KEY?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"context\": \"all\",
              \"value\": \"${{ secrets.SUPABASE_ANON_KEY }}\"
            }"
          
          echo "âœ… Set NEXT_PUBLIC_SUPABASE_ANON_KEY"
      
      - name: Set SUPABASE_SERVICE_ROLE_KEY
        if: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY != '' }}
        run: |
          echo "Setting SUPABASE_SERVICE_ROLE_KEY..."
          
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/SUPABASE_SERVICE_ROLE_KEY?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"context\": \"all\",
              \"value\": \"${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}\"
            }"
          
          echo "âœ… Set SUPABASE_SERVICE_ROLE_KEY"
      
      - name: Set Site URLs
        run: |
          echo "Setting site URLs..."
          
          # NEXT_PUBLIC_APP_URL
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/NEXT_PUBLIC_APP_URL?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"context": "all", "value": "https://elevateconnectsdirectory.org"}'
          
          # NEXT_PUBLIC_SITE_URL
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/NEXT_PUBLIC_SITE_URL?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"context": "all", "value": "https://elevateconnectsdirectory.org"}'
          
          # NODE_ENV
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/*/env/NODE_ENV?site_id=${{ secrets.NETLIFY_SITE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"context": "all", "value": "production"}'
          
          echo "âœ… Site URLs set"
      
      - name: Trigger Netlify Build
        run: |
          echo "ðŸš€ Triggering Netlify build..."
          
          curl -X POST \
            "https://api.netlify.com/api/v1/sites/${{ secrets.NETLIFY_SITE_ID }}/builds" \
            -H "Authorization: Bearer ${{ secrets.NETLIFY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"clear_cache": true}'
          
          echo ""
          echo "âœ… Build triggered!"
          echo "Monitor at: https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys"
      
      - name: Summary
        if: always()
        run: |
          echo "# ðŸ¤– Autopilot Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment Variables Set" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SUPABASE_URL = https://cuxzzpsyufcewtmicszk.supabase.co" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SUPABASE_ANON_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SUPABASE_SERVICE_ROLE_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NODE_ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Netlify build triggered with cleared cache" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Wait 2-3 minutes then check:" >> $GITHUB_STEP_SUMMARY
          echo "- https://elevateconnectsdirectory.org" >> $GITHUB_STEP_SUMMARY
