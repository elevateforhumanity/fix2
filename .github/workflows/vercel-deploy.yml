name: Vercel Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.0

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Set Vercel Environment Variables
        run: |
          echo "ðŸ”§ Setting environment variables in Vercel..."

          # Function to set or update environment variable
          set_env_var() {
            local key=$1
            local value=$2
            local target=$3
            
            echo "Setting $key..."
            
            # Try to remove existing variable (ignore errors if it doesn't exist)
            vercel env rm "$key" "$target" --yes --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
            
            # Add the new value
            echo "$value" | vercel env add "$key" "$target" --token=${{ secrets.VERCEL_TOKEN }}
          }

          # Set all environment variables for production
          set_env_var "VITE_SUPABASE_URL" "${{ secrets.VITE_SUPABASE_URL }}" "production"
          set_env_var "VITE_SUPABASE_ANON_KEY" "${{ secrets.VITE_SUPABASE_ANON_KEY }}" "production"
          set_env_var "VITE_STRIPE_PUBLISHABLE_KEY" "${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}" "production"
          set_env_var "VITE_API_URL" "${{ secrets.VITE_API_URL }}" "production"
          set_env_var "VITE_SITE_URL" "${{ secrets.VITE_SITE_URL }}" "production"
          set_env_var "VITE_GA_MEASUREMENT_ID" "G-EFHWORKFORCE01" "production"

          echo "âœ… Environment variables configured"

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $DEPLOYMENT_URL"

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"

          # Wait for deployment to be ready
          sleep 10

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Deployment verified successfully"
            echo "ðŸŒ Site is live at: $DEPLOY_URL"
          else
            echo "âš ï¸ Deployment returned HTTP $HTTP_CODE"
            echo "Site may still be initializing..."
          fi

      - name: Create Deployment Report
        if: always()
        run: |
          cat > VERCEL_DEPLOYMENT_REPORT.md << 'EOF'
          # Vercel Deployment Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Deployment Status

          âœ… Deployed to Vercel Production

          **URL:** ${{ steps.deploy.outputs.url }}

          ## Environment Variables Configured

          - âœ… VITE_SUPABASE_URL
          - âœ… VITE_SUPABASE_ANON_KEY
          - âœ… VITE_STRIPE_PUBLISHABLE_KEY
          - âœ… VITE_API_URL
          - âœ… VITE_SITE_URL
          - âœ… VITE_GA_MEASUREMENT_ID

          ## Build Configuration

          - **Framework:** Vite
          - **Node Version:** 20.11.1
          - **Package Manager:** pnpm 9.7.0
          - **Output Directory:** dist

          ## Next Steps

          1. Visit the deployment URL to verify the site loads correctly
          2. Test authentication flow with Supabase
          3. Verify Stripe payment integration
          4. Check Google Analytics tracking

          ## Monitoring

          - **Vercel Dashboard:** https://vercel.com/dashboard
          - **Deployment Logs:** https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}

          ---

          *Deployed automatically by GitHub Actions*
          EOF

          echo "âœ… Deployment report created"

      - name: Commit Deployment Report
        run: |
          git config --local user.email "vercel-deploy@elevateforhumanity.org"
          git config --local user.name "Vercel Deploy Bot"

          git add VERCEL_DEPLOYMENT_REPORT.md || true
          git commit -m "chore: vercel deployment report

          Deployed to: ${{ steps.deploy.outputs.url }}
          Commit: ${{ github.sha }}

          Co-authored-by: Ona <no-reply@ona.com>" || echo "No changes to commit"

          git push origin main || echo "Nothing to push"

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸš€ Vercel Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variables" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Supabase configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stripe configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analytics configured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Visit your site: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
