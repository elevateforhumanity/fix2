name: Autopilot - Configure Vercel Environment

on:
  workflow_dispatch:
    inputs:
      trigger_deploy:
        description: 'Also trigger a Vercel production deploy'
        type: boolean
        default: false
      set_node_version:
        description: 'Set Node.js version (20 or 22)'
        type: choice
        options:
          - '20'
          - '22'
        default: '20'

jobs:
  config-vercel-env:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.set_node_version }}

      - name: Install dependencies (for vercel CLI if needed)
        run: |
          npm init -y >/dev/null 2>&1 || true

      - name: Make script executable
        run: chmod +x scripts/autopilot-config-vercel.sh

      - name: Run Vercel env autopilot
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

          SUPABASE_URL: 'https://cuxzzpsyufcewtmicszk.supabase.co'
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          APP_URL: 'https://elevateconnectsdirectory.org'

          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}

          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          ./scripts/autopilot-config-vercel.sh

      - name: Optional â€“ Trigger Vercel Deploy
        if: ${{ inputs.trigger_deploy == true }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ðŸš€ Triggering Vercel production deploy..."
          npx vercel --prod --token "$VERCEL_TOKEN" --yes

      - name: Summary
        run: |
          echo "## âœ… Vercel Configuration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Node Version:** ${{ inputs.set_node_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Triggered:** ${{ inputs.trigger_deploy }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All environment variables have been set for:" >> $GITHUB_STEP_SUMMARY
          echo "- Production" >> $GITHUB_STEP_SUMMARY
          echo "- Preview" >> $GITHUB_STEP_SUMMARY
          echo "- Development" >> $GITHUB_STEP_SUMMARY
