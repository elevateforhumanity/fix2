name: Autopilot ‚Äì Fix LMS Pages, Routing, Assets, and Placeholder Data

on:
  workflow_dispatch:
    inputs:
      auto_commit:
        description: "Automatically commit fixes to main branch"
        required: false
        type: boolean
        default: false
      fix_routing:
        description: "Fix routing and domain links"
        required: false
        type: boolean
        default: true
      fix_skeletons:
        description: "Remove skeleton loaders"
        required: false
        type: boolean
        default: true
      fix_mock_data:
        description: "Remove mock/placeholder data"
        required: false
        type: boolean
        default: true
      fix_assets:
        description: "Create missing assets"
        required: false
        type: boolean
        default: true

jobs:
  page-audit-and-fix:
    name: Run LMS Page Completeness Autopilot
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Autopilot ‚Äì Scan Codebase
        id: scan
        run: |
          echo "# üîç LMS Page Completeness Audit" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          mkdir -p autopilot-report
          REPORT="autopilot-report/scan.txt"

          echo "=== AUTOPILOT PAGE AUDIT REPORT ===" > $REPORT
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $REPORT
          echo "" >> $REPORT

          # Count issues
          skeleton_count=0
          mock_count=0
          todo_count=0
          localhost_count=0
          vercel_count=0
          missing_image_count=0

          echo "## üß© Skeleton Loaders" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Checking for skeleton loaders..." >> $REPORT
          if grep -R "Skeleton" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            skeleton_count=$(grep -R "Skeleton" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ö†Ô∏è Found $skeleton_count skeleton loader reference(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ No skeleton loaders found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üé≠ Mock/Demo Data" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> $REPORT
          echo "Checking for mock/demo data..." >> $REPORT
          if grep -R -E "(const mock|demoData|placeholder|dummy)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            mock_count=$(grep -R -E "(const mock|demoData|placeholder|dummy)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ö†Ô∏è Found $mock_count mock/placeholder data reference(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ No mock data found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üìù TODO/Unfinished Markers" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> $REPORT
          echo "Checking for TODO/unfinished markers..." >> $REPORT
          if grep -R -E "(TODO|FIXME|HACK|XXX)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            todo_count=$(grep -R -E "(TODO|FIXME|HACK|XXX)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ö†Ô∏è Found $todo_count TODO/FIXME marker(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ No TODO markers found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üîó Wrong Domain Links" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> $REPORT
          echo "Checking for localhost links..." >> $REPORT
          if grep -R -E "(localhost|127\.0\.0\.1)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            localhost_count=$(grep -R -E "(localhost|127\.0\.0\.1)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ö†Ô∏è Found $localhost_count localhost reference(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ No localhost references found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> $REPORT
          echo "Checking for Vercel links..." >> $REPORT
          if grep -R "vercel\.app" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            vercel_count=$(grep -R "vercel\.app" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ö†Ô∏è Found $vercel_count Vercel URL reference(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ No Vercel URLs found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üñºÔ∏è Missing Images" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> $REPORT
          echo "Checking for image imports..." >> $REPORT
          if grep -R "import.*\.(png|jpg|jpeg|svg|webp)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" -n . 2>/dev/null >> $REPORT; then
            missing_image_count=$(grep -R "import.*\.(png|jpg|jpeg|svg|webp)" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" . 2>/dev/null | wc -l)
            echo "‚ÑπÔ∏è Found $missing_image_count image import(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ÑπÔ∏è No image imports found" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> $REPORT
          echo "Audit complete." >> $REPORT

          # Set outputs
          echo "skeleton_count=$skeleton_count" >> "$GITHUB_OUTPUT"
          echo "mock_count=$mock_count" >> "$GITHUB_OUTPUT"
          echo "todo_count=$todo_count" >> "$GITHUB_OUTPUT"
          echo "localhost_count=$localhost_count" >> "$GITHUB_OUTPUT"
          echo "vercel_count=$vercel_count" >> "$GITHUB_OUTPUT"
          echo "missing_image_count=$missing_image_count" >> "$GITHUB_OUTPUT"

          total_issues=$((skeleton_count + mock_count + localhost_count + vercel_count))
          echo "total_issues=$total_issues" >> "$GITHUB_OUTPUT"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Total Issues Found**: $total_issues" >> "$GITHUB_STEP_SUMMARY"

      - name: Autopilot ‚Äì Fix Routing and Domain Links
        if: inputs.fix_routing == true && steps.scan.outputs.localhost_count != '0' || steps.scan.outputs.vercel_count != '0'
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üîß Fixing Routing and Domain Links" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          fixed_count=0

          # Fix localhost references
          find . -type f \( -name "*.tsx" -o -name "*.jsx" -o -name "*.ts" -o -name "*.js" \) ! -path "*/node_modules/*" ! -path "*/.next/*" | while read file; do
            if grep -q "http://localhost:3000" "$file"; then
              sed -i 's|http://localhost:3000|https://elevateconnectsdirectory.org|g' "$file"
              echo "‚úÖ Fixed localhost in: $file" >> "$GITHUB_STEP_SUMMARY"
              fixed_count=$((fixed_count + 1))
            fi
            
            if grep -q "http://127.0.0.1:3000" "$file"; then
              sed -i 's|http://127.0.0.1:3000|https://elevateconnectsdirectory.org|g' "$file"
              echo "‚úÖ Fixed 127.0.0.1 in: $file" >> "$GITHUB_STEP_SUMMARY"
              fixed_count=$((fixed_count + 1))
            fi
            
            if grep -q "vercel\.app" "$file"; then
              sed -i 's|[a-zA-Z0-9-]*\.vercel\.app|elevateconnectsdirectory.org|g' "$file"
              echo "‚úÖ Fixed Vercel URL in: $file" >> "$GITHUB_STEP_SUMMARY"
              fixed_count=$((fixed_count + 1))
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Fixed**: $fixed_count file(s)" >> "$GITHUB_STEP_SUMMARY"

      - name: Autopilot ‚Äì Remove Skeleton Loaders
        if: inputs.fix_skeletons == true && steps.scan.outputs.skeleton_count != '0'
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üßπ Removing Skeleton Loaders" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Create a list of files with skeletons
          find . -type f \( -name "*.tsx" -o -name "*.jsx" \) ! -path "*/node_modules/*" ! -path "*/.next/*" | while read file; do
            if grep -q "Skeleton" "$file"; then
              echo "‚ö†Ô∏è Found skeleton in: $file" >> "$GITHUB_STEP_SUMMARY"
              echo "   ‚Üí Manual review recommended - skeleton loaders may be intentional loading states" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Note**: Skeleton loaders not automatically removed - they may be legitimate loading states." >> "$GITHUB_STEP_SUMMARY"
          echo "Review the files above and replace with real Supabase data calls if needed." >> "$GITHUB_STEP_SUMMARY"

      - name: Autopilot ‚Äì Flag Mock Data
        if: inputs.fix_mock_data == true && steps.scan.outputs.mock_count != '0'
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üé≠ Mock Data Detection" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # List files with mock data
          find . -type f \( -name "*.tsx" -o -name "*.jsx" -o -name "*.ts" -o -name "*.js" \) ! -path "*/node_modules/*" ! -path "*/.next/*" | while read file; do
            if grep -q -E "(const mock|demoData|placeholder|dummy)" "$file"; then
              echo "‚ö†Ô∏è Found mock data in: $file" >> "$GITHUB_STEP_SUMMARY"
              
              # Show the lines with mock data
              grep -n -E "(const mock|demoData|placeholder|dummy)" "$file" | head -3 | while read line; do
                echo "   \`$line\`" >> "$GITHUB_STEP_SUMMARY"
              done
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Action Required**: Replace mock data with real Supabase queries" >> "$GITHUB_STEP_SUMMARY"

      - name: Autopilot ‚Äì Create Missing Assets
        if: inputs.fix_assets == true
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üì∏ Asset Management" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Ensure assets directory exists
          mkdir -p public/elevate-auto-assets
          mkdir -p public/images
          mkdir -p public/hero

          echo "‚úÖ Created/verified asset directories:" >> "$GITHUB_STEP_SUMMARY"
          echo "   - \`public/elevate-auto-assets/\`" >> "$GITHUB_STEP_SUMMARY"
          echo "   - \`public/images/\`" >> "$GITHUB_STEP_SUMMARY"
          echo "   - \`public/hero/\`" >> "$GITHUB_STEP_SUMMARY"

          # Create a default placeholder SVG
          cat > public/elevate-auto-assets/placeholder.svg << 'EOF'
          <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
            <rect width="400" height="300" fill="#f0f0f0"/>
            <text x="50%" y="50%" font-family="Arial" font-size="20" fill="#999" text-anchor="middle" dominant-baseline="middle">
              Elevate for Humanity
            </text>
          </svg>
          EOF

          echo "‚úÖ Created default placeholder image" >> "$GITHUB_STEP_SUMMARY"

      - name: Autopilot ‚Äì Generate Fix Report
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üìä Autopilot Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Issues Detected" >> "$GITHUB_STEP_SUMMARY"
          echo "- Skeleton loaders: ${{ steps.scan.outputs.skeleton_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Mock data references: ${{ steps.scan.outputs.mock_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- TODO markers: ${{ steps.scan.outputs.todo_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Localhost references: ${{ steps.scan.outputs.localhost_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Vercel URLs: ${{ steps.scan.outputs.vercel_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.scan.outputs.total_issues }}" -eq 0 ]; then
            echo "‚úÖ **Status**: All pages are production-ready" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ö†Ô∏è **Status**: ${{ steps.scan.outputs.total_issues }} issue(s) require attention" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "${{ steps.scan.outputs.skeleton_count }}" -gt 0 ]; then
            echo "1. Review skeleton loaders and replace with real Supabase data" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          if [ "${{ steps.scan.outputs.mock_count }}" -gt 0 ]; then
            echo "2. Replace mock data with real database queries" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          if [ "${{ steps.scan.outputs.localhost_count }}" -gt 0 ] || [ "${{ steps.scan.outputs.vercel_count }}" -gt 0 ]; then
            echo "3. Review and commit routing fixes" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ü§ñ *Page Completeness Autopilot completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autopilot-audit-report
          path: autopilot-report/
          retention-days: 30

      - name: Autopilot ‚Äì Commit Fixes
        if: inputs.auto_commit == true && steps.scan.outputs.total_issues != '0'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Autopilot: Fix routing, assets, and page completeness issues"
          branch: main
          commit_user_name: "Elevate Autopilot"
          commit_user_email: "autopilot@elevateforhumanity.org"
          commit_author: "Elevate Autopilot <autopilot@elevateforhumanity.org>"

      - name: Trigger Netlify Deploy
        if: inputs.auto_commit == true && steps.scan.outputs.total_issues != '0'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          if [ -n "$NETLIFY_AUTH_TOKEN" ] && [ -n "$NETLIFY_SITE_ID" ]; then
            echo "üöÄ Triggering Netlify redeploy..."
            
            curl -X POST \
              "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds" \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"clear_cache": true}'
            
            echo "‚úÖ Netlify deploy triggered"
          else
            echo "‚ÑπÔ∏è Netlify secrets not configured - skipping deploy trigger"
          fi
