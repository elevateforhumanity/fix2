name: Autopilot â€“ Vercel Environment Guardian

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Force Vercel redeploy even if nothing changed'
        required: false
        type: boolean
        default: false

jobs:
  vercel-guardian:
    name: Check, Correct, and Set Vercel Env Vars
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required GitHub Secrets
        run: |
          echo "# ðŸ” Validating GitHub Secrets" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          missing=0

          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âŒ Missing secret: VERCEL_TOKEN" >> "$GITHUB_STEP_SUMMARY"
            missing=1
          else
            echo "âœ… VERCEL_TOKEN present" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -z "$VERCEL_ORG_ID" ]; then
            echo "âŒ Missing secret: VERCEL_ORG_ID" >> "$GITHUB_STEP_SUMMARY"
            missing=1
          else
            echo "âœ… VERCEL_ORG_ID present" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "âŒ Missing secret: VERCEL_PROJECT_ID" >> "$GITHUB_STEP_SUMMARY"
            missing=1
          else
            echo "âœ… VERCEL_PROJECT_ID present" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âŒ Missing secret: SUPABASE_ANON_KEY" >> "$GITHUB_STEP_SUMMARY"
            missing=1
          else
            echo "âœ… SUPABASE_ANON_KEY present" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ Missing secret: SUPABASE_SERVICE_ROLE_KEY" >> "$GITHUB_STEP_SUMMARY"
            missing=1
          else
            echo "âœ… SUPABASE_SERVICE_ROLE_KEY present" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "$missing" -ne 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âš ï¸ One or more required secrets are missing." >> "$GITHUB_STEP_SUMMARY"
            echo "Go to: Settings â†’ Secrets and variables â†’ Actions" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… All required GitHub Secrets are present." >> "$GITHUB_STEP_SUMMARY"

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Check and fix critical env vars
        id: fixenv
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "# ðŸ›  Vercel Environment Variables" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          CORRECT_SUPABASE_URL="https://cuxzzpsyufcewtmicszk.supabase.co"
          CORRECT_APP_URL="https://elevateconnectsdirectory.org"

          fixed_count=0
          created_count=0
          unchanged_count=0

          # Function to set environment variable in Vercel
          set_vercel_env() {
            VAR_NAME="$1"
            VAR_VALUE="$2"
            
            echo "Setting $VAR_NAME in Vercel..."
            
            # Remove existing variable if it exists
            vercel env rm "$VAR_NAME" production --yes --token="$VERCEL_TOKEN" 2>/dev/null || true
            
            # Add new value
            echo "$VAR_VALUE" | vercel env add "$VAR_NAME" production --token="$VERCEL_TOKEN" > /dev/null
            
            echo "âœ… Set $VAR_NAME" >> "$GITHUB_STEP_SUMMARY"
          }

          echo "## Setting Environment Variables" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Set all required variables
          set_vercel_env "NEXT_PUBLIC_SUPABASE_URL" "$CORRECT_SUPABASE_URL"
          set_vercel_env "NEXT_PUBLIC_SUPABASE_ANON_KEY" "$SUPABASE_ANON_KEY"
          set_vercel_env "SUPABASE_SERVICE_ROLE_KEY" "$SUPABASE_SERVICE_ROLE_KEY"
          set_vercel_env "NEXT_PUBLIC_APP_URL" "$CORRECT_APP_URL"
          set_vercel_env "NEXT_PUBLIC_SITE_URL" "$CORRECT_APP_URL"
          set_vercel_env "NEXT_PUBLIC_BASE_URL" "$CORRECT_APP_URL"
          set_vercel_env "NODE_ENV" "production"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… All environment variables configured" >> "$GITHUB_STEP_SUMMARY"

          echo "needs_redeploy=true" >> "$GITHUB_OUTPUT"

      - name: Trigger Vercel redeploy
        if: steps.fixenv.outputs.needs_redeploy == 'true' || inputs.force_redeploy == true
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "# ðŸš€ Triggering Vercel Redeploy" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Trigger deployment via Vercel CLI
          vercel deploy --prod --token="$VERCEL_TOKEN" --yes

          echo "âœ… Deployment triggered successfully" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Monitor at: https://vercel.com/$VERCEL_ORG_ID/$VERCEL_PROJECT_ID" >> "$GITHUB_STEP_SUMMARY"

      - name: Summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "# ðŸ“Š Autopilot Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source of truth for Supabase URL: https://cuxzzpsyufcewtmicszk.supabase.co" >> "$GITHUB_STEP_SUMMARY"
          echo "- Keys pulled from GitHub Secrets and synced to Vercel" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "If site still shows errors:" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Wait 5 minutes for Vercel deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Check Vercel build logs" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Verify Supabase project is active" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ¤– *Vercel Guardian completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$GITHUB_STEP_SUMMARY"
