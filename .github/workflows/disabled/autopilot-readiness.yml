name: Autopilot â€“ Student & Partner Readiness Check

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to test (default: production)'
        required: false
        default: 'https://elevateconnectsdirectory.org'
  schedule:
    # Run daily at 10:00 UTC (optional - can be disabled)
    - cron: '0 10 * * *'
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'pages/**'
      - 'components/**'

jobs:
  readiness-check:
    name: Test Production Site as Student & Partner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install --no-save node-fetch@3

      - name: Run readiness check script
        id: readiness
        env:
          READINESS_BASE_URL: ${{ inputs.base_url || 'https://elevateconnectsdirectory.org' }}
        run: |
          echo "# ðŸ¤– Student & Partner Readiness Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Testing**: $READINESS_BASE_URL" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          node scripts/readiness-check.mjs

      - name: Summary on success
        if: success()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## âœ… Readiness Check Passed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "All critical pages are:" >> "$GITHUB_STEP_SUMMARY"
          echo "- Loading successfully (no 500 errors)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Free of obvious errors" >> "$GITHUB_STEP_SUMMARY"
          echo "- Not showing skeleton loaders" >> "$GITHUB_STEP_SUMMARY"
          echo "- Not showing placeholder content" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Status**: Site is ready for students and partners ðŸŽ“" >> "$GITHUB_STEP_SUMMARY"

      - name: Summary on failure
        if: failure()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## âŒ Readiness Check Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "One or more critical pages have issues:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Possible Issues" >> "$GITHUB_STEP_SUMMARY"
          echo "- Server errors (500)" >> "$GITHUB_STEP_SUMMARY"
          echo "- Internal Server Error messages" >> "$GITHUB_STEP_SUMMARY"
          echo "- Skeleton loaders still visible" >> "$GITHUB_STEP_SUMMARY"
          echo "- Placeholder/mock content" >> "$GITHUB_STEP_SUMMARY"
          echo "- Missing environment variables" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Recommended Actions" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Check the logs above for specific failures" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Run **Autopilot â€“ Fix Netlify Environment Variables**" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Review Netlify build logs" >> "$GITHUB_STEP_SUMMARY"
          echo "4. Test the failing pages manually" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Status**: Site needs attention before student/partner onboarding âš ï¸" >> "$GITHUB_STEP_SUMMARY"

      - name: Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Readiness Check Failed - Site Issues Detected';
            const body = `## Automated Readiness Check Failed

            The nightly readiness check detected issues with the production site.

            **Time**: ${new Date().toISOString()}
            **URL**: https://elevateconnectsdirectory.org

            ### What This Means

            One or more critical pages are:
            - Returning server errors (500)
            - Showing error messages
            - Displaying skeleton loaders
            - Showing placeholder content

            ### Action Required

            1. Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Check which specific pages failed
            3. Run the Netlify Environment Guardian autopilot
            4. Review Netlify build logs
            5. Test fixes manually

            ### Related Workflows

            - [Autopilot â€“ Fix Netlify Environment Variables](${context.payload.repository.html_url}/actions/workflows/autopilot-netlify-guardian.yml)
            - [Autopilot â€“ Fix LMS Pages](${context.payload.repository.html_url}/actions/workflows/autopilot-fix-pages.yml)

            ---

            *This issue was automatically created by the Readiness Check autopilot.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'autopilot,readiness-check'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['autopilot', 'readiness-check', 'bug', 'priority-high']
              });
            }

      - name: Final summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ¤– *Readiness Check completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$GITHUB_STEP_SUMMARY"
