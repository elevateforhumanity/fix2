name: Autopilot Self-Heal (Vercel)

on:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes
  workflow_dispatch:
    inputs:
      force_heal:
        description: 'Force healing even if healthy'
        required: false
        default: 'false'

jobs:
  selfheal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load autopilot configuration
        id: autopilot_config
        run: |
          echo "ðŸ¤– Loading autopilot configuration..."
          
          # Load from .env.production
          if [ -f .env.production ]; then
            set -a
            source .env.production
            set +a
            echo "âœ… Loaded configuration from .env.production"
          else
            echo "âš ï¸ .env.production not found"
          fi
          
          # Set site URL (from env or default)
          SITE_URL="${VITE_SITE_URL:-https://fix2.vercel.app}"
          echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
          echo "Site URL: $SITE_URL"
          
          # Check if Vercel is configured
          if [ -f .vercel/project.json ]; then
            VERCEL_ORG_ID=$(cat .vercel/project.json | grep -o '"orgId":"[^"]*"' | cut -d'"' -f4)
            VERCEL_PROJECT_ID=$(cat .vercel/project.json | grep -o '"projectId":"[^"]*"' | cut -d'"' -f4)
            echo "vercel_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Vercel project linked"
          else
            echo "vercel_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Vercel not linked yet"
          fi

      - name: Check site health
        id: health_check
        run: |
          echo "ðŸ¥ Checking site health..."
          
          SITE_URL="${{ steps.autopilot_config.outputs.site_url }}"
          
          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SITE_URL" || echo "000")
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [[ "$HTTP_CODE" -ge 200 ]] && [[ "$HTTP_CODE" -lt 400 ]]; then
            echo "healthy=true" >> $GITHUB_OUTPUT
            echo "âœ… Site healthy (HTTP $HTTP_CODE)"
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Site unhealthy (HTTP $HTTP_CODE)"
          fi

      - name: Log healthy status
        if: steps.health_check.outputs.healthy == 'true'
        run: |
          echo "âœ… System healthy - no action needed"
          echo "Site: ${{ steps.autopilot_config.outputs.site_url }}"
          echo "Status: HTTP ${{ steps.health_check.outputs.http_code }}"

      - name: Self-Heal - Trigger Vercel Redeploy
        if: steps.health_check.outputs.healthy == 'false' || github.event.inputs.force_heal == 'true'
        id: redeploy
        run: |
          echo "ðŸ”§ Triggering self-heal..."
          
          # Check if Vercel is configured
          if [[ "${{ steps.autopilot_config.outputs.vercel_configured }}" != "true" ]]; then
            echo "âš ï¸ Vercel not configured - run: bash scripts/autopilot-vercel-setup.sh"
            echo "status=not_configured" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for Vercel token (from GitHub secrets or autopilot)
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âš ï¸ VERCEL_TOKEN not in GitHub secrets"
            echo "ðŸ’¡ Run: bash scripts/autopilot-github-secrets.sh"
            echo "status=no_token" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Install Vercel CLI
          npm i -g vercel
          
          # Trigger redeploy using token from secrets
          echo "ðŸš€ Triggering Vercel redeploy..."
          vercel --prod --yes --token="${{ secrets.VERCEL_TOKEN }}" || {
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Redeploy triggered successfully"

      - name: Wait for recovery
        if: steps.redeploy.outputs.status == 'success'
        run: |
          echo "â³ Waiting 60 seconds for deployment..."
          sleep 60

      - name: Verify recovery
        if: steps.redeploy.outputs.status == 'success'
        id: verify
        run: |
          echo "ðŸ” Verifying recovery..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SITE_URL" || echo "000")
          
          echo "http_code_after=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [[ "$HTTP_CODE" -ge 200 ]] && [[ "$HTTP_CODE" -lt 400 ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Recovery successful (HTTP $HTTP_CODE)"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Recovery failed (HTTP $HTTP_CODE)"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ¤– Autopilot Self-Heal Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** $SITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.health_check.outputs.healthy }}" == "true" ]]; then
            echo "### âœ… System Healthy" >> $GITHUB_STEP_SUMMARY
            echo "No action needed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.redeploy.outputs.status }}" == "success" ]] && [[ "${{ steps.verify.outputs.success }}" == "true" ]]; then
            echo "### âœ… Self-Heal Successful" >> $GITHUB_STEP_SUMMARY
            echo "- Detected issue: HTTP ${{ steps.health_check.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
            echo "- Triggered redeploy" >> $GITHUB_STEP_SUMMARY
            echo "- Verified recovery: HTTP ${{ steps.verify.outputs.http_code_after }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.redeploy.outputs.status }}" == "skipped" ]]; then
            echo "### âš ï¸ Self-Heal Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Vercel not configured - add VERCEL_TOKEN secret" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Self-Heal Failed" >> $GITHUB_STEP_SUMMARY
            echo "Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create escalation issue (only if self-heal failed)
        if: |
          steps.health_check.outputs.healthy == 'false' && 
          steps.redeploy.outputs.status == 'success' && 
          steps.verify.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if there's already a recent escalation issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'self-heal-failed',
              state: 'open',
              per_page: 1
            });
            
            // Only create if no issue in last 24 hours
            if (issues.data.length > 0) {
              const lastIssue = issues.data[0];
              const hoursSinceLastIssue = (Date.now() - new Date(lastIssue.created_at)) / (1000 * 60 * 60);
              
              if (hoursSinceLastIssue < 24) {
                console.log(`Recent escalation issue exists (#${lastIssue.number}), skipping creation`);
                return;
              }
            }
            
            // Create escalation issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Autopilot Self-Heal Failed - Manual Check Needed',
              body: `## Self-Heal Failure Report
              
**Time:** ${new Date().toISOString()}
**Site:** ${process.env.SITE_URL}

### Status

- **Initial Check:** HTTP ${{ steps.health_check.outputs.http_code }} (unhealthy)
- **Self-Heal Action:** Triggered Vercel redeploy
- **After Recovery:** HTTP ${{ steps.verify.outputs.http_code_after }} (still unhealthy)

### What Happened

1. âœ… Detected site was unhealthy
2. âœ… Triggered automatic Vercel redeploy
3. â³ Waited 60 seconds for recovery
4. âŒ Site still unhealthy after redeploy

### Next Steps

1. Check Vercel deployment logs: https://vercel.com/dashboard
2. Review recent commits for breaking changes
3. Verify environment variables are set correctly
4. Check for infrastructure issues

### Workflow Run

[View logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

---

*This issue was created because automatic healing failed. The autopilot will continue monitoring and will try to heal again in 30 minutes.*

**Note:** Only one escalation issue is created per 24 hours to avoid spam.`,
              labels: ['autopilot', 'self-heal-failed', 'needs-attention']
            });
            
            console.log(`Created escalation issue #${issue.data.number}`);
