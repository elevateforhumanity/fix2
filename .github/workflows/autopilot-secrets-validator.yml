name: Autopilot â€“ GitHub Secrets Validator

on:
  workflow_dispatch:
  schedule:
    # Run nightly at 2 AM UTC to catch missing secrets
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/autopilot-secrets-validator.yml'
      - 'AUTOPILOT_CHARTER.md'

jobs:
  validate-secrets:
    name: Validate Required GitHub Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required secrets exist
        id: check-secrets
        run: |
          echo "# ðŸ” GitHub Secrets Validation" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Required Secrets Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          missing=0
          present=0

          # Check VERCEL_TOKEN
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ **VERCEL_TOKEN** - Missing" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ Add from: Vercel dashboard â†’ Settings â†’ Tokens â†’ Create Token" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            missing=$((missing+1))
          else
            echo "âœ… **VERCEL_TOKEN** - Present" >> "$GITHUB_STEP_SUMMARY"
            present=$((present+1))
          fi

          # Check VERCEL_ORG_ID
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "âŒ **VERCEL_ORG_ID** - Missing" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ Add from: Vercel dashboard â†’ Settings â†’ General â†’ Organization ID" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            missing=$((missing+1))
          else
            echo "âœ… **VERCEL_ORG_ID** - Present" >> "$GITHUB_STEP_SUMMARY"
            present=$((present+1))
          fi

          # Check VERCEL_PROJECT_ID
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "âŒ **VERCEL_PROJECT_ID** - Missing" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ Add from: Vercel project â†’ Settings â†’ General â†’ Project ID" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            missing=$((missing+1))
          else
            echo "âœ… **VERCEL_PROJECT_ID** - Present" >> "$GITHUB_STEP_SUMMARY"
            present=$((present+1))
          fi

          # Check SUPABASE_ANON_KEY
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "âŒ **SUPABASE_ANON_KEY** - Missing" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ Add from: Supabase dashboard â†’ Settings â†’ API â†’ anon public key" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            missing=$((missing+1))
          else
            echo "âœ… **SUPABASE_ANON_KEY** - Present" >> "$GITHUB_STEP_SUMMARY"
            present=$((present+1))
          fi

          # Check SUPABASE_SERVICE_ROLE_KEY
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "âŒ **SUPABASE_SERVICE_ROLE_KEY** - Missing" >> "$GITHUB_STEP_SUMMARY"
            echo "   â†’ Add from: Supabase dashboard â†’ Settings â†’ API â†’ service_role key (click Reveal)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            missing=$((missing+1))
          else
            echo "âœ… **SUPABASE_SERVICE_ROLE_KEY** - Present" >> "$GITHUB_STEP_SUMMARY"
            present=$((present+1))
          fi

          # Summary
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- âœ… Present: $present" >> "$GITHUB_STEP_SUMMARY"
          echo "- âŒ Missing: $missing" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Set outputs
          echo "missing_count=$missing" >> "$GITHUB_OUTPUT"
          echo "present_count=$present" >> "$GITHUB_OUTPUT"

          if [ "$missing" -gt 0 ]; then
            echo "## âš ï¸ Action Required" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Add missing secrets at: **Settings â†’ Secrets and variables â†’ Actions**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "After adding secrets, run the **Autopilot â€“ Vercel Environment Guardian** workflow to sync them to Vercel." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## âœ… All Secrets Present" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "All required GitHub Secrets are configured correctly." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Next Step**: Run **Autopilot â€“ Vercel Environment Guardian** to ensure Vercel is in sync." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Validate Supabase URL in repo config
        id: check-supabase-url
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ” Repository Configuration Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          CORRECT_SUPABASE_URL="https://cuxzzpsyufcewtmicszk.supabase.co"
          
          # Check .env.production if it exists
          if [ -f ".env.production" ]; then
            echo "Checking **.env.production**..." >> "$GITHUB_STEP_SUMMARY"
            
            if grep -q "NEXT_PUBLIC_SUPABASE_URL" .env.production; then
              REPO_URL=$(grep "NEXT_PUBLIC_SUPABASE_URL" .env.production | cut -d '=' -f2 | tr -d '"' | tr -d "'" | xargs)
              
              if [ "$REPO_URL" = "$CORRECT_SUPABASE_URL" ]; then
                echo "âœ… NEXT_PUBLIC_SUPABASE_URL is correct: \`$REPO_URL\`" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "âš ï¸ NEXT_PUBLIC_SUPABASE_URL is incorrect:" >> "$GITHUB_STEP_SUMMARY"
                echo "   - Found: \`$REPO_URL\`" >> "$GITHUB_STEP_SUMMARY"
                echo "   - Expected: \`$CORRECT_SUPABASE_URL\`" >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "**Note**: Vercel autopilot will override this with the correct value." >> "$GITHUB_STEP_SUMMARY"
              fi
            else
              echo "â„¹ï¸ NEXT_PUBLIC_SUPABASE_URL not found in .env.production" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "â„¹ï¸ .env.production not found (this is okay - Vercel uses environment variables)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fail if secrets missing
        if: steps.check-secrets.outputs.missing_count != '0'
        run: |
          echo "::error::${{ steps.check-secrets.outputs.missing_count }} required GitHub Secret(s) are missing. Check workflow summary for details."
          exit 1

      - name: Success notification
        if: steps.check-secrets.outputs.missing_count == '0'
        run: |
          echo "âœ… All required GitHub Secrets are present and validated."
          echo ""
          echo "ðŸ¤– Autopilot Guardian is ready to sync environment variables to Vercel."
