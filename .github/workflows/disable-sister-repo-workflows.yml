name: Disable Workflows in Sister Repositories

# This workflow can be manually triggered to disable scheduled workflows
# in other Elevate for Humanity repositories

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Comma-separated list of repositories to process'
        required: false
        default: 'ecosystem2,ecosystem3,ecosystem-5,new-ecosysstem,new2,tiny-new'
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        default: 'false'

jobs:
  disable-workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fix2 repository
        uses: actions/checkout@v4
        with:
          path: fix2
      
      - name: Setup Git
        run: |
          git config --global user.name "Elevate Autopilot"
          git config --global user.email "noreply@elevateforhumanity.org"
      
      - name: Process repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IFS=',' read -ra REPOS <<< "${{ github.event.inputs.repositories }}"
          
          for REPO in "${REPOS[@]}"; do
            REPO=$(echo "$REPO" | xargs) # trim whitespace
            echo "=========================================="
            echo "Processing: $REPO"
            echo "=========================================="
            
            # Clone repository
            if ! gh repo clone "elevateforhumanity/$REPO" "$REPO" 2>/dev/null; then
              echo "‚ùå Failed to clone $REPO (may not exist or no access)"
              continue
            fi
            
            cd "$REPO"
            
            # Check for workflows
            if [ ! -d ".github/workflows" ]; then
              echo "‚ÑπÔ∏è  No workflows directory"
              cd ..
              continue
            fi
            
            # Create disabled directory
            mkdir -p ".github/workflows/disabled"
            
            # Find and move scheduled workflows
            MOVED=0
            for workflow in .github/workflows/*.{yml,yaml}; do
              [ -f "$workflow" ] || continue
              
              if grep -q "schedule:" "$workflow"; then
                WORKFLOW_NAME=$(basename "$workflow")
                echo "üî¥ Disabling: $WORKFLOW_NAME"
                git mv "$workflow" ".github/workflows/disabled/$WORKFLOW_NAME" || true
                MOVED=$((MOVED + 1))
              fi
            done
            
            if [ $MOVED -gt 0 ]; then
              echo "‚úÖ Disabled $MOVED workflow(s)"
              
              git add .github/workflows/
              git commit -m "DISABLE scheduled workflows: Stop autopilot cron jobs

- Moved $MOVED scheduled workflow(s) to disabled/ folder
- Prevents automated runs during manual deployment work
- Focus on fix2 repository deployment

Co-authored-by: Ona <no-reply@ona.com>" || true
              
              if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
                git push origin HEAD || echo "‚ö†Ô∏è  Failed to push"
              else
                echo "‚ÑπÔ∏è  Dry run - not pushing changes"
              fi
            else
              echo "‚úÖ No scheduled workflows found"
            fi
            
            cd ..
            echo ""
          done
          
          echo "=========================================="
          echo "‚úÖ Complete!"
          echo "=========================================="
