name: Netlify Build Monitor

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  monitor-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.1'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.7.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        id: typecheck
        run: |
          if pnpm run typecheck; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run ESLint check
        id: lint
        run: |
          if pnpm run lint; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test build
        id: build
        run: |
          if CI=true pnpm run build; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report status
        if: always()
        run: |
          echo "## ðŸ” Netlify Build Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**TypeScript:** ${{ steps.typecheck.outputs.status || 'failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**ESLint:** ${{ steps.lint.outputs.status || 'failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ steps.build.outputs.status || 'failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.typecheck.outputs.status }}" = "success" ] && [ "${{ steps.lint.outputs.status }}" = "success" ] && [ "${{ steps.build.outputs.status }}" = "success" ]; then
            echo "âœ… **All checks passing - Netlify builds should succeed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Checks failing - Netlify builds will fail**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action needed:** Merge pending PRs to fix errors" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue if build fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Netlify Build Monitor: Errors Detected';
            const body = `## Build Monitor Alert
            
            The automated build monitor has detected errors that will cause Netlify builds to fail.
            
            ### Status
            - TypeScript: ${{ steps.typecheck.outputs.status || 'failed' }}
            - ESLint: ${{ steps.lint.outputs.status || 'failed' }}
            - Build: ${{ steps.build.outputs.status || 'failed' }}
            
            ### Action Required
            1. Check open PRs for fixes
            2. Merge PRs that resolve errors
            3. Monitor this workflow for success
            
            ### Workflow Run
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            *This issue was automatically created by the Netlify Build Monitor*`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'netlify-monitor'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['netlify-monitor', 'bug', 'automated']
              });
            }
