name: Branch Protection Guard
on:
  push:
    branches: [main]
  schedule:
    - cron: '19 3 * * *'
  workflow_dispatch: {}

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
      - name: Node
        uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Audit rule
        id: audit
        env:
          REPO_SLUG: elevateforhumanity/fix2
          BRANCH: main
          REQUIRED_CHECKS: 'build-test,check'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node autopilot/branch-protection/audit-branch-protection.mjs
      - name: Open/Update issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = "Branch protection drift: CI checks required"
            const body = [
              "The branch protection rule for `main` is missing required settings.",
              "",
              "- Required checks: `build-test`, `check`",
              "- Strict up-to-date merge required",
              "- Conversation resolution enabled",
              "- Enforce admins",
              "",
              "Action: Run the **Apply Branch Protection** workflow or execute the setup script."
            ].join("\n")
            // find existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: undefined
            })
            const exists = issues.find(i => i.title === title)
            if (exists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: exists.number,
                body: "Audit failed again. Please re-apply the rule."
              })
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body
              })
            }
