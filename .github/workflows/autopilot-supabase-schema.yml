name: Autopilot â€“ Supabase Schema Guardian

on:
  workflow_dispatch:
    inputs:
      auto_commit:
        description: "Automatically commit generated schema stubs"
        required: false
        type: boolean
        default: false

jobs:
  supabase-schema-guardian:
    name: Scan Code & Generate Supabase Schema Stubs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run schema guardian script
        run: |
          echo "# ðŸ¤– Supabase Schema Guardian" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Scanning codebase for Supabase table and RPC usage..." >> "$GITHUB_STEP_SUMMARY"
          
          node scripts/autopilot-supabase-schema.mjs

      - name: Check for generated files
        id: check-files
        run: |
          if [ -d "supabase/autopilot-migrations" ] && [ "$(ls -A supabase/autopilot-migrations)" ]; then
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "## ðŸ“‹ Generated Schema Stubs" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Files created in \`supabase/autopilot-migrations/\`:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            ls -1 supabase/autopilot-migrations/ | while read file; do
              echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
            done
          else
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âœ… No new schema stubs needed - all tables appear to be defined" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Display schema summary
        if: steps.check-files.outputs.has_files == 'true'
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“Š Schema Analysis" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          # Count tables and RPCs
          TABLES=$(grep -h "CREATE TABLE" supabase/autopilot-migrations/*.sql 2>/dev/null | wc -l || echo "0")
          RPCS=$(grep -h "Detected RPC function" supabase/autopilot-migrations/*.sql 2>/dev/null | wc -l || echo "0")
          
          echo "- **Tables detected**: $TABLES" >> "$GITHUB_STEP_SUMMARY"
          echo "- **RPC functions detected**: $RPCS" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Review generated SQL files in \`supabase/autopilot-migrations/\`" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Update table definitions with actual columns" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Apply migrations via Supabase CLI or dashboard" >> "$GITHUB_STEP_SUMMARY"
          echo "4. Test application with new schema" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload schema stubs as artifact
        if: steps.check-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: supabase-schema-stubs
          path: supabase/autopilot-migrations/
          retention-days: 90

      - name: Commit generated schema stubs
        if: inputs.auto_commit == true && steps.check-files.outputs.has_files == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Autopilot: Generate Supabase schema stubs from code usage"
          branch: main
          commit_user_name: "Elevate Autopilot"
          commit_user_email: "autopilot@elevateforhumanity.org"
          commit_author: "Elevate Autopilot <autopilot@elevateforhumanity.org>"
          file_pattern: "supabase/autopilot-migrations/*.sql"

      - name: Summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "${{ steps.check-files.outputs.has_files }}" == "true" ]; then
            echo "âœ… **Status**: Schema stubs generated successfully" >> "$GITHUB_STEP_SUMMARY"
            
            if [ "${{ inputs.auto_commit }}" == "true" ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "ðŸ”„ **Auto-commit**: Enabled - changes committed to main branch" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "ðŸ“¥ **Download**: Schema stubs available as workflow artifact" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âœ… **Status**: No schema gaps detected" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ¤– *Schema Guardian completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> "$GITHUB_STEP_SUMMARY"
