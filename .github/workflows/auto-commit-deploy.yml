name: Auto Commit & Deploy

on:
  # Trigger on push to development branches
  push:
    branches:
      - 'dev/**'
      - 'feature/**'
      - 'fix/**'
      - 'autopilot/**'

  # Manual trigger
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to auto-commit and deploy'
        required: true
        default: 'dev/auto'
      commit_message:
        description: 'Commit message'
        required: false
        default: 'chore: autopilot auto-commit'

jobs:
  auto-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run autopilot checks
        id: autopilot
        run: |
          echo "Running autopilot checks..."
          node tools/autopilot.mjs || echo "Some checks failed, continuing..."

      - name: Run auto-fixes
        run: |
          echo "Running auto-fixes..."
          pnpm run autopilot:fix || echo "Some fixes failed, continuing..."

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "autopilot@elevateforhumanity.org"
          git config --local user.name "EFH Autopilot"

          # Add all changes
          git add -A

          # Create commit
          COMMIT_MSG="${{ github.event.inputs.commit_message || 'chore: autopilot auto-commit and fixes' }}"
          git commit -m "$COMMIT_MSG" \
            -m "Auto-generated by GitHub Actions" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_number }}" \
            -m "" \
            -m "Co-authored-by: Ona <no-reply@ona.com>"

          echo "‚úÖ Changes committed"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin HEAD
          echo "‚úÖ Changes pushed to ${{ github.ref_name }}"

      - name: Build application
        run: |
          echo "Building application..."
          pnpm run build

      - name: Deploy to Netlify (Preview)
        if: github.ref != 'refs/heads/main'
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from ${{ github.ref_name }} - Run ${{ github.run_number }}'
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Create summary
        if: always()
        run: |
          echo "## ü§ñ Autopilot Auto-Commit & Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.changes.outputs.has_changes == 'true' && '‚úÖ Committed & Pushed' || '‚ÑπÔ∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Ran autopilot checks" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Applied auto-fixes" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "- ‚úÖ Committed changes" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Pushed to remote" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ‚úÖ Built application" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "- ‚úÖ Deployed preview to Netlify" >> $GITHUB_STEP_SUMMARY
          fi

  notify-success:
    needs: auto-commit-deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "‚úÖ Auto-commit and deploy completed successfully"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

  notify-failure:
    needs: auto-commit-deploy
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "‚ùå Auto-commit and deploy failed"
          echo "Branch: ${{ github.ref_name }}"
          echo "Check logs for details"
