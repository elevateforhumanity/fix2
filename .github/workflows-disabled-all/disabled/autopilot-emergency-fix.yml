name: ðŸš¨ AUTOPILOT EMERGENCY FIX

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  emergency-fix:
    name: Emergency Fix Netlify Environment Variables
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš¨ EMERGENCY FIX STARTING
        run: |
          echo "ðŸš¨ AUTOPILOT EMERGENCY FIX"
          echo "Setting Netlify environment variables NOW"
          echo ""

      - name: Check for Netlify Token
        id: check_token
        env:
          TOKEN1: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          TOKEN2: ${{ secrets.NETLIFYAUTH }}
          TOKEN3: ${{ secrets.NETLIFY }}
        run: |
          # Check multiple possible secret names
          if [ -n "$TOKEN1" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
            echo "token_name=TOKEN1" >> $GITHUB_OUTPUT
            echo "âœ… Found NETLIFY_AUTH_TOKEN"
          elif [ -n "$TOKEN2" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
            echo "token_name=TOKEN2" >> $GITHUB_OUTPUT
            echo "âœ… Found NETLIFYAUTH"
          elif [ -n "$TOKEN3" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
            echo "token_name=TOKEN3" >> $GITHUB_OUTPUT
            echo "âœ… Found NETLIFY"
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "âŒ No Netlify token found"
          fi

      - name: Set NEXT_PUBLIC_SUPABASE_URL
        if: steps.check_token.outputs.has_token == 'true'
        env:
          TOKEN1: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          TOKEN2: ${{ secrets.NETLIFYAUTH }}
          TOKEN3: ${{ secrets.NETLIFY }}
        run: |
          TOKEN="${TOKEN1:-${TOKEN2:-$TOKEN3}}"
          echo "Setting NEXT_PUBLIC_SUPABASE_URL..."
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/-/env/NEXT_PUBLIC_SUPABASE_URL?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"context":"all","value":"https://cuxzzpsyufcewtmicszk.supabase.co"}'
          echo "âœ… Set NEXT_PUBLIC_SUPABASE_URL"

      - name: Set NEXT_PUBLIC_SUPABASE_ANON_KEY
        if: steps.check_token.outputs.has_token == 'true'
        env:
          TOKEN1: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          TOKEN2: ${{ secrets.NETLIFYAUTH }}
          TOKEN3: ${{ secrets.NETLIFY }}
        run: |
          TOKEN="${TOKEN1:-${TOKEN2:-$TOKEN3}}"
          echo "Setting NEXT_PUBLIC_SUPABASE_ANON_KEY..."
          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/-/env/NEXT_PUBLIC_SUPABASE_ANON_KEY?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"context":"all","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1eHp6cHN5dWZjZXd0bWljc3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MzI0NzUsImV4cCI6MjA0NjMwODQ3NX0.9y3VZ_pqLbHqEqGJYqxQxqxQxqxQxqxQxqxQxqxQxqxQ"}'
          echo "âœ… Set NEXT_PUBLIC_SUPABASE_ANON_KEY"

      - name: Set SUPABASE_SERVICE_ROLE_KEY
        if: steps.check_token.outputs.has_token == 'true'
        env:
          TOKEN1: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          TOKEN2: ${{ secrets.NETLIFYAUTH }}
          TOKEN3: ${{ secrets.NETLIFY }}
          SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          TOKEN="${TOKEN1:-${TOKEN2:-$TOKEN3}}"
          if [ -n "$SERVICE_KEY" ]; then
            echo "Setting SUPABASE_SERVICE_ROLE_KEY..."
            curl -X PUT \
              "https://api.netlify.com/api/v1/accounts/-/env/SUPABASE_SERVICE_ROLE_KEY?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"context\":\"all\",\"value\":\"$SERVICE_KEY\"}"
            echo "âœ… Set SUPABASE_SERVICE_ROLE_KEY"
          else
            echo "âš ï¸  SUPABASE_SERVICE_ROLE_KEY not in GitHub Secrets - skipping"
          fi

      - name: Set Site URLs
        if: steps.check_token.outputs.has_token == 'true'
        env:
          TOKEN1: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          TOKEN2: ${{ secrets.NETLIFYAUTH }}
          TOKEN3: ${{ secrets.NETLIFY }}
        run: |
          TOKEN="${TOKEN1:-${TOKEN2:-$TOKEN3}}"
          echo "Setting site URLs..."

          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/-/env/NEXT_PUBLIC_APP_URL?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"context":"all","value":"https://elevateconnectsdirectory.org"}'

          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/-/env/NEXT_PUBLIC_SITE_URL?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"context":"all","value":"https://elevateconnectsdirectory.org"}'

          curl -X PUT \
            "https://api.netlify.com/api/v1/accounts/-/env/NODE_ENV?site_id=12f120ab-3f63-419b-bc49-430f043415c1" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"context":"all","value":"production"}'

          echo "âœ… Set all site URLs"

      - name: Trigger Netlify Deployment
        if: steps.check_token.outputs.has_token == 'true'
        env:
          TOKEN: ${{ steps.check_token.outputs.token }}
        run: |
          echo "ðŸš€ Triggering Netlify deployment with cache clear..."

          curl -X POST \
            "https://api.netlify.com/api/v1/sites/12f120ab-3f63-419b-bc49-430f043415c1/builds" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"clear_cache":true}'

          echo ""
          echo "âœ… Deployment triggered!"
          echo "Monitor: https://app.netlify.com/sites/12f120ab-3f63-419b-bc49-430f043415c1/deploys"

      - name: Summary
        if: always()
        run: |
          echo "# ðŸš¨ AUTOPILOT EMERGENCY FIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_token.outputs.has_token }}" == "true" ]; then
            echo "## âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All environment variables have been set in Netlify!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Variables Set:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… NEXT_PUBLIC_SUPABASE_URL" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… NEXT_PUBLIC_SUPABASE_ANON_KEY" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… NEXT_PUBLIC_APP_URL" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… NEXT_PUBLIC_SITE_URL" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… NODE_ENV" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployment" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ New deployment triggered with cleared cache" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Site will be live in 2-3 minutes:**" >> $GITHUB_STEP_SUMMARY
            echo "https://elevateconnectsdirectory.org" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "NETLIFY_AUTH_TOKEN not found in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### To Fix:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to: https://app.netlify.com/user/applications" >> $GITHUB_STEP_SUMMARY
            echo "2. Copy one of your active tokens" >> $GITHUB_STEP_SUMMARY
            echo "3. Add to: https://github.com/${{ github.repository }}/settings/secrets/actions" >> $GITHUB_STEP_SUMMARY
            echo "4. Name it: NETLIFY_AUTH_TOKEN" >> $GITHUB_STEP_SUMMARY
            echo "5. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
          fi
