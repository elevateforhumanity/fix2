import{r as e,j as t}from"./vendor-react-mXmGo1rS.js";import{supabase as a}from"./supabaseClient-mnOK5lWJ.js";import{A as s}from"./AppLayout-C3pbRaS2.js";import"./vendor-BU8AdXDg.js";import"./vendor-supabase-BOQaJsF3.js";import"./vendor-router-umqT_8ks.js";function r(){const[r,n]=e.useState([]),[d,o]=e.useState(null),[i,l]=e.useState(!0),[c,x]=e.useState("all");e.useEffect(()=>{u(),p();const e=setInterval(()=>{u(),p()},1e4);return()=>clearInterval(e)},[c]);const u=async()=>{if(a)try{let e=a.from("automation.tasks").select("*").order("updated_at",{ascending:!1}).limit(100);"all"!==c&&(e=e.eq("status",c));const{data:t,error:s}=await e;if(s)throw s;n(t||[])}catch(e){console.error("Error loading tasks:",e)}finally{l(!1)}},p=async()=>{if(a)try{const{data:e,error:t}=await a.from("automation.task_stats").select("*");if(t)throw t;o(e)}catch(e){console.error("Error loading stats:",e)}},m=e=>{switch(e){case"succeeded":return"bg-brand-surface text-brand-success";case"failed":return"bg-brand-surface text-red-800";case"running":return"bg-brand-surface text-brand-info";case"needs_approval":return"bg-yellow-100 text-yellow-800";case"queued":default:return"bg-brand-surface-dark text-brand-text";case"skipped":return"bg-brand-surface-dark text-brand-text-muted"}},h=e=>{switch(e){case"succeeded":return"âœ…";case"failed":return"âŒ";case"running":return"â³";case"needs_approval":return"âš ï¸";case"queued":return"ðŸ“‹";case"skipped":return"â­ï¸";default:return"â“"}};return t.jsx(s,{children:t.jsxs("div",{className:"container mx-auto px-4 py-8",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h1",{className:"text-3xl font-bold",children:"Autopilot Tasks"}),t.jsx("button",{onClick:()=>u(),className:"px-4 py-2 bg-brand-info text-white rounded-lg hover:bg-brand-info-hover",children:"ðŸ”„ Refresh"})]}),d&&t.jsx("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4 mb-6",children:d.map(e=>t.jsxs("div",{className:"bg-white rounded-lg shadow p-4 text-center",children:[t.jsx("div",{className:"text-2xl mb-1",children:h(e.status)}),t.jsx("div",{className:"text-2xl font-bold",children:e.count}),t.jsx("div",{className:"text-sm text-brand-text-muted capitalize",children:e.status}),e.avg_duration_seconds&&t.jsxs("div",{className:"text-xs text-brand-text-light mt-1",children:["~",e.avg_duration_seconds,"s avg"]})]},e.status))}),t.jsx("div",{className:"bg-white rounded-lg shadow mb-6",children:t.jsx("div",{className:"flex border-b overflow-x-auto",children:["all","queued","running","needs_approval","succeeded","failed","skipped"].map(e=>t.jsx("button",{onClick:()=>x(e),className:"px-6 py-3 font-medium transition whitespace-nowrap "+(c===e?"border-b-2 border-blue-600 text-brand-info":"text-brand-text-muted hover:text-brand-text"),children:e.charAt(0).toUpperCase()+e.slice(1).replace("_"," ")},e))})}),i?t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),t.jsx("p",{className:"mt-4 text-brand-text-muted",children:"Loading tasks..."})]}):0===r.length?t.jsx("div",{className:"bg-white rounded-lg shadow p-12 text-center",children:t.jsx("p",{className:"text-brand-text-light text-lg",children:"No tasks found"})}):t.jsx("div",{className:"space-y-4",children:r.map(e=>t.jsxs("div",{className:"bg-white rounded-lg shadow p-6 hover:shadow-lg transition",children:[t.jsxs("div",{className:"flex justify-between items-start mb-4",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[t.jsx("span",{className:"text-2xl",children:h(e.status)}),t.jsxs("h3",{className:"text-xl font-bold",children:["#",e.id," - ",e.kind]}),t.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-semibold ${m(e.status)}`,children:e.status}),e.requires_approval&&t.jsx("span",{className:"px-3 py-1 bg-brand-surface text-brand-warning rounded-full text-sm font-semibold",children:"Requires Approval"})]}),t.jsxs("div",{className:"text-sm text-brand-text-muted space-y-1",children:[t.jsxs("p",{children:["Priority: ",e.priority," | Attempts: ",e.attempts,"/",e.max_attempts]}),t.jsxs("p",{children:["Created: ",new Date(e.created_at).toLocaleString()]}),e.started_at&&t.jsxs("p",{children:["Started: ",new Date(e.started_at).toLocaleString()]}),e.completed_at&&t.jsxs("p",{children:["Completed:"," ",new Date(e.completed_at).toLocaleString()]})]})]}),t.jsxs("div",{className:"flex gap-2 ml-4",children:["needs_approval"===e.status&&t.jsx("button",{onClick:()=>(async e=>{if(a)try{const{data:{user:t}}=await a.auth.getUser();if(!t)return;if(!(await fetch(void 0,{method:"POST",headers:{"Content-Type":"application/json","x-autopilot-sign":void 0},body:JSON.stringify({task:"approve",id:e,approver:t.id})})).ok)throw new Error("Failed to approve task");await u()}catch(t){console.error("Error approving task:",t),alert("Failed to approve task")}})(e.id),className:"px-4 py-2 bg-brand-success text-white rounded hover:bg-brand-success-hover text-sm font-bold",children:"âœ“ Approve"}),"failed"===e.status&&t.jsx("button",{onClick:()=>(async e=>{try{if(!(await fetch(void 0,{method:"POST",headers:{"Content-Type":"application/json","x-autopilot-sign":void 0},body:JSON.stringify({task:"retry",id:e})})).ok)throw new Error("Failed to retry task");await u()}catch(t){console.error("Error retrying task:",t),alert("Failed to retry task")}})(e.id),className:"px-4 py-2 bg-brand-info text-white rounded hover:bg-brand-info-hover text-sm",children:"ðŸ”„ Retry"}),["queued","running","needs_approval"].includes(e.status)&&t.jsx("button",{onClick:()=>(async e=>{if(confirm("Are you sure you want to cancel this task?"))try{if(!(await fetch(void 0,{method:"POST",headers:{"Content-Type":"application/json","x-autopilot-sign":void 0},body:JSON.stringify({task:"cancel",id:e})})).ok)throw new Error("Failed to cancel task");await u()}catch(t){console.error("Error cancelling task:",t),alert("Failed to cancel task")}})(e.id),className:"px-4 py-2 bg-brand-danger text-white rounded hover:bg-brand-danger-hover text-sm",children:"âœ— Cancel"})]})]}),Object.keys(e.payload).length>0&&t.jsxs("details",{className:"mt-4",children:[t.jsx("summary",{className:"cursor-pointer text-sm font-semibold text-brand-text hover:text-brand-text",children:"View Payload"}),t.jsx("pre",{className:"mt-2 p-4 bg-brand-surface rounded text-xs overflow-x-auto",children:JSON.stringify(e.payload,null,2)})]}),e.error&&t.jsxs("div",{className:"mt-4 p-4 bg-red-50 border border-red-200 rounded",children:[t.jsx("p",{className:"text-sm font-semibold text-red-900 mb-1",children:"Error:"}),t.jsx("p",{className:"text-sm text-red-800",children:e.error})]})]},e.id))})]})})}export{r as default};
