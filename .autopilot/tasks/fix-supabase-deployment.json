{
  "task_id": "fix-supabase-deployment",
  "name": "Fix Supabase Keys and Deploy to Netlify",
  "description": "Get Supabase keys, add to GitHub Secrets and Netlify, fix deployment error",
  "version": "1.0.0",
  "priority": "critical",
  "estimated_time": "10 minutes",
  "error": "Missing Supabase environment variables for admin client",
  "steps": [
    {
      "step": 1,
      "title": "Access Supabase Dashboard",
      "type": "manual",
      "instructions": [
        "Open browser and go to: https://supabase.com/dashboard",
        "Sign in with your account",
        "Select project: cuxzzpsyufcewtmicszk",
        "Or go directly to: https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Are you logged into Supabase dashboard?"
      }
    },
    {
      "step": 2,
      "title": "Get Supabase API Keys",
      "type": "manual",
      "instructions": [
        "In Supabase dashboard, click 'Settings' (gear icon, bottom left)",
        "Click 'API' in the settings menu",
        "Or go directly to: https://supabase.com/dashboard/project/cuxzzpsyufcewtmicszk/settings/api",
        "",
        "You will see 3 keys:",
        "1. Project URL",
        "2. anon public key",
        "3. service_role secret key",
        "",
        "Copy all three - you'll need them in next steps"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Have you copied all 3 keys?"
      },
      "output": {
        "save_to_file": "analysis/supabase-keys.txt",
        "fields": ["project_url", "anon_key", "service_role_key"]
      }
    },
    {
      "step": 3,
      "title": "Add Keys to GitHub Secrets",
      "type": "manual",
      "instructions": [
        "Open new tab: https://github.com/elevateforhumanity/fix2/settings/secrets/actions",
        "",
        "Add Secret 1:",
        "  Name: NEXT_PUBLIC_SUPABASE_URL",
        "  Secret: [Paste Project URL from Step 2]",
        "  Click 'Add secret'",
        "",
        "Add Secret 2:",
        "  Name: NEXT_PUBLIC_SUPABASE_ANON_KEY",
        "  Secret: [Paste anon public key from Step 2]",
        "  Click 'Add secret'",
        "",
        "Add Secret 3:",
        "  Name: SUPABASE_SERVICE_ROLE_KEY",
        "  Secret: [Paste service_role secret key from Step 2]",
        "  Click 'Add secret'",
        "",
        "IMPORTANT: The service_role key is sensitive - never commit to code!"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Have you added all 3 secrets to GitHub?"
      },
      "screenshots_needed": true
    },
    {
      "step": 4,
      "title": "Add Keys to Netlify Environment Variables",
      "type": "manual",
      "instructions": [
        "Open new tab: https://app.netlify.com/",
        "Log in to Netlify",
        "Find your site (Site ID: 12f120ab-3f63-419b-bc49-430f043415c1)",
        "Go to: Site settings → Environment variables",
        "",
        "Add Variable 1:",
        "  Key: NEXT_PUBLIC_SUPABASE_URL",
        "  Value: [Paste Project URL from Step 2]",
        "  Scopes: All scopes (or Production)",
        "  Click 'Create variable'",
        "",
        "Add Variable 2:",
        "  Key: NEXT_PUBLIC_SUPABASE_ANON_KEY",
        "  Value: [Paste anon public key from Step 2]",
        "  Scopes: All scopes (or Production)",
        "  Click 'Create variable'",
        "",
        "Add Variable 3:",
        "  Key: SUPABASE_SERVICE_ROLE_KEY",
        "  Value: [Paste service_role secret key from Step 2]",
        "  Scopes: All scopes (or Production)",
        "  Click 'Create variable'"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Have you added all 3 variables to Netlify?"
      },
      "screenshots_needed": true
    },
    {
      "step": 5,
      "title": "Add Additional Required Variables to Netlify",
      "type": "manual",
      "instructions": [
        "Still in Netlify Environment variables, add these:",
        "",
        "Variable 4:",
        "  Key: NEXT_PUBLIC_APP_URL",
        "  Value: https://elevateconnectsdirectory.org",
        "  Scopes: Production",
        "",
        "Variable 5:",
        "  Key: NEXT_PUBLIC_SITE_URL",
        "  Value: https://elevateconnectsdirectory.org",
        "  Scopes: Production",
        "",
        "Variable 6:",
        "  Key: NODE_ENV",
        "  Value: production",
        "  Scopes: Production",
        "",
        "Click 'Save' after adding all variables"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Have you added all 6 variables total?"
      }
    },
    {
      "step": 6,
      "title": "Verify All Variables Are Set",
      "type": "manual",
      "instructions": [
        "In Netlify Environment variables page, verify you see:",
        "",
        "✓ NEXT_PUBLIC_SUPABASE_URL",
        "✓ NEXT_PUBLIC_SUPABASE_ANON_KEY",
        "✓ SUPABASE_SERVICE_ROLE_KEY",
        "✓ NEXT_PUBLIC_APP_URL",
        "✓ NEXT_PUBLIC_SITE_URL",
        "✓ NODE_ENV",
        "",
        "Total: 6 variables",
        "",
        "If any are missing, add them now before proceeding"
      ],
      "validation": {
        "type": "checklist",
        "items": [
          "NEXT_PUBLIC_SUPABASE_URL",
          "NEXT_PUBLIC_SUPABASE_ANON_KEY",
          "SUPABASE_SERVICE_ROLE_KEY",
          "NEXT_PUBLIC_APP_URL",
          "NEXT_PUBLIC_SITE_URL",
          "NODE_ENV"
        ]
      }
    },
    {
      "step": 7,
      "title": "Clear Netlify Build Cache",
      "type": "manual",
      "instructions": [
        "In Netlify, go to: Deploys tab",
        "Click 'Trigger deploy' dropdown",
        "Select 'Clear cache and deploy site'",
        "This ensures a fresh build with new environment variables",
        "Click to confirm"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Have you triggered a clear cache deploy?"
      }
    },
    {
      "step": 8,
      "title": "Monitor Deployment",
      "type": "manual",
      "instructions": [
        "Stay on the Deploys page",
        "Watch the build log in real-time",
        "Look for these success indicators:",
        "  ✓ 'Building Next.js...'",
        "  ✓ 'Compiled successfully'",
        "  ✓ 'Collecting page data' (should complete without errors)",
        "  ✓ 'Site is live'",
        "",
        "Build should take 2-4 minutes",
        "",
        "If you see 'Missing Supabase environment variables' again:",
        "  - Double-check all 6 variables are set correctly",
        "  - Verify no typos in variable names (case-sensitive)",
        "  - Try clearing cache and deploying again"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Did the deployment succeed?"
      },
      "timeout": 300
    },
    {
      "step": 9,
      "title": "Verify Site is Live",
      "type": "manual",
      "instructions": [
        "Once deployment shows 'Published', test the site:",
        "",
        "1. Open: https://elevateconnectsdirectory.org",
        "   - Should load without errors",
        "",
        "2. Check: https://elevateconnectsdirectory.org/sitemap.xml",
        "   - Should show XML sitemap",
        "",
        "3. Check: https://elevateconnectsdirectory.org/robots.txt",
        "   - Should show robots.txt content",
        "",
        "4. Try navigating to a few pages:",
        "   - /lms/courses",
        "   - /programs",
        "   - /login",
        "",
        "All pages should load correctly"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Is the site loading correctly?"
      }
    },
    {
      "step": 10,
      "title": "Test Supabase Connection",
      "type": "manual",
      "instructions": [
        "To verify Supabase is connected:",
        "",
        "1. Go to: https://elevateconnectsdirectory.org/login",
        "2. Try to log in (or sign up if you have test account)",
        "3. If login works, Supabase connection is successful",
        "",
        "Or check browser console (F12):",
        "  - Should see no Supabase errors",
        "  - Network tab should show successful requests to Supabase",
        "",
        "If you see errors:",
        "  - Check the anon key is correct",
        "  - Verify the URL matches your Supabase project"
      ],
      "validation": {
        "type": "confirmation",
        "message": "Is Supabase connection working?"
      },
      "optional": true
    },
    {
      "step": 11,
      "title": "Document Configuration",
      "type": "automated",
      "instructions": [
        "Save configuration details for future reference:",
        "  - Supabase Project ID: cuxzzpsyufcewtmicszk",
        "  - Supabase URL: https://cuxzzpsyufcewtmicszk.supabase.co",
        "  - Netlify Site ID: 12f120ab-3f63-419b-bc49-430f043415c1",
        "  - Production URL: https://elevateconnectsdirectory.org",
        "  - Deployment Date: [Current date]",
        "",
        "Keys are stored in:",
        "  - GitHub Secrets (for CI/CD)",
        "  - Netlify Environment Variables (for deployments)",
        "",
        "NEVER commit service_role key to repository!"
      ],
      "output": {
        "save_to_file": "analysis/deployment-config.json",
        "format": "json",
        "fields": [
          "supabase_project_id",
          "supabase_url",
          "netlify_site_id",
          "production_url",
          "deployment_date",
          "keys_location"
        ]
      }
    }
  ],
  "completion": {
    "message": "✅ Supabase keys configured and site deployed successfully!",
    "next_steps": [
      "Site is live at: https://elevateconnectsdirectory.org",
      "Monitor Netlify analytics for traffic",
      "Set up Google Analytics (optional)",
      "Submit sitemap to Google Search Console",
      "Test all functionality thoroughly"
    ],
    "verification": [
      "✓ Site loads without errors",
      "✓ Sitemap.xml accessible",
      "✓ Robots.txt accessible",
      "✓ Supabase connection working",
      "✓ No build errors in Netlify"
    ]
  },
  "troubleshooting": {
    "common_errors": [
      {
        "error": "Missing Supabase environment variables",
        "solution": "Verify all 3 Supabase variables are set in Netlify with correct names (case-sensitive)"
      },
      {
        "error": "Invalid API key",
        "solution": "Copy keys again from Supabase dashboard, ensure no extra spaces or characters"
      },
      {
        "error": "Build timeout",
        "solution": "Clear Netlify cache and try again, or check for other build errors in logs"
      },
      {
        "error": "Site shows 404",
        "solution": "Wait 5-10 minutes for DNS propagation, clear browser cache"
      }
    ]
  },
  "security_notes": [
    "⚠️ NEVER commit SUPABASE_SERVICE_ROLE_KEY to Git",
    "⚠️ Service role key has admin access - keep it secret",
    "✅ Anon key is safe to expose (public key)",
    "✅ Store all keys in GitHub Secrets and Netlify only",
    "✅ Rotate service role key if ever exposed"
  ]
}
