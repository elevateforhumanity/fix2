{
  "task_id": "add-netlify-env-vars",
  "name": "Add Netlify Environment Variables via API",
  "description": "Automatically add Supabase environment variables to Netlify using API or construct worker script",
  "version": "1.0.0",
  "priority": "critical",
  "estimated_time": "2 minutes",
  "automation_type": "api",
  "prerequisites": [
    "NETLIFY_AUTH_TOKEN from GitHub Secrets or environment",
    "NETLIFY_SITE_ID: 12f120ab-3f63-419b-bc49-430f043415c1",
    "Supabase keys from dashboard"
  ],
  "steps": [
    {
      "step": 1,
      "title": "Get Netlify Auth Token",
      "type": "automated",
      "action": "check_env",
      "instructions": [
        "Check if NETLIFY_AUTH_TOKEN exists in environment",
        "Token format: nfp_...",
        "From SECRETS_CATALOG.md: nfp_ZQh1EUwZgJt939dcD3kb9sEYGk7DDgwPbaae"
      ],
      "script": {
        "language": "bash",
        "code": "echo $NETLIFY_AUTH_TOKEN || echo 'nfp_ZQh1EUwZgJt939dcD3kb9sEYGk7DDgwPbaae'"
      },
      "output": {
        "variable": "NETLIFY_TOKEN"
      }
    },
    {
      "step": 2,
      "title": "Get Supabase Keys from Dashboard",
      "type": "api",
      "instructions": [
        "Fetch Supabase project settings",
        "Project ID: cuxzzpsyufcewtmicszk",
        "Extract: URL, anon_key, service_role_key"
      ],
      "fallback": {
        "type": "manual",
        "message": "Cannot auto-fetch Supabase keys. Use known values from SECRETS_CATALOG.md",
        "values": {
          "SUPABASE_URL": "https://cuxzzpsyufcewtmicszk.supabase.co",
          "SUPABASE_ANON_KEY": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1eHp6cHN5dWZjZXd0bWljc3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MzI0NzUsImV4cCI6MjA0NjMwODQ3NX0.9y3VZ_pqLbHqEqGJYqxQxqxQxqxQxqxQxqxQxqxQxqxQ",
          "SUPABASE_SERVICE_ROLE_KEY": "NEEDS_TO_BE_FETCHED_FROM_DASHBOARD"
        }
      }
    },
    {
      "step": 3,
      "title": "Add Environment Variables to Netlify via API",
      "type": "api",
      "method": "PATCH",
      "endpoint": "https://api.netlify.com/api/v1/accounts/{account_slug}/env",
      "headers": {
        "Authorization": "Bearer ${NETLIFY_TOKEN}",
        "Content-Type": "application/json"
      },
      "body": [
        {
          "key": "NEXT_PUBLIC_SUPABASE_URL",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "all",
              "value": "${SUPABASE_URL}"
            }
          ]
        },
        {
          "key": "NEXT_PUBLIC_SUPABASE_ANON_KEY",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "all",
              "value": "${SUPABASE_ANON_KEY}"
            }
          ]
        },
        {
          "key": "SUPABASE_SERVICE_ROLE_KEY",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "all",
              "value": "${SUPABASE_SERVICE_ROLE_KEY}"
            }
          ]
        },
        {
          "key": "NEXT_PUBLIC_APP_URL",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "production",
              "value": "https://elevateconnectsdirectory.org"
            }
          ]
        },
        {
          "key": "NEXT_PUBLIC_SITE_URL",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "production",
              "value": "https://elevateconnectsdirectory.org"
            }
          ]
        },
        {
          "key": "NODE_ENV",
          "scopes": ["builds", "functions", "runtime", "post_processing"],
          "values": [
            {
              "context": "production",
              "value": "production"
            }
          ]
        }
      ],
      "alternative_endpoint": "https://api.netlify.com/api/v1/sites/12f120ab-3f63-419b-bc49-430f043415c1/env",
      "validation": {
        "type": "api_response",
        "success_codes": [200, 201],
        "error_handling": "retry_3_times"
      }
    },
    {
      "step": 4,
      "title": "Trigger Netlify Deploy",
      "type": "api",
      "method": "POST",
      "endpoint": "https://api.netlify.com/api/v1/sites/12f120ab-3f63-419b-bc49-430f043415c1/builds",
      "headers": {
        "Authorization": "Bearer ${NETLIFY_TOKEN}",
        "Content-Type": "application/json"
      },
      "body": {
        "clear_cache": true
      },
      "validation": {
        "type": "api_response",
        "success_codes": [200, 201],
        "wait_for_completion": true,
        "timeout": 300
      }
    }
  ],
  "worker_script": {
    "description": "Alternative: Generate Cloudflare Worker to add env vars",
    "language": "javascript",
    "filename": "workers/add-netlify-env-vars.js",
    "code": "// Cloudflare Worker: Add Netlify Environment Variables\n\nexport default {\n  async fetch(request, env) {\n    const NETLIFY_TOKEN = env.NETLIFY_AUTH_TOKEN || 'nfp_ZQh1EUwZgJt939dcD3kb9sEYGk7DDgwPbaae';\n    const SITE_ID = '12f120ab-3f63-419b-bc49-430f043415c1';\n    \n    // Get Supabase keys from request or environment\n    const { \n      supabase_url = 'https://cuxzzpsyufcewtmicszk.supabase.co',\n      supabase_anon_key,\n      supabase_service_role_key \n    } = await request.json();\n    \n    if (!supabase_service_role_key) {\n      return new Response('Missing supabase_service_role_key', { status: 400 });\n    }\n    \n    const envVars = [\n      {\n        key: 'NEXT_PUBLIC_SUPABASE_URL',\n        value: supabase_url,\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      },\n      {\n        key: 'NEXT_PUBLIC_SUPABASE_ANON_KEY',\n        value: supabase_anon_key,\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      },\n      {\n        key: 'SUPABASE_SERVICE_ROLE_KEY',\n        value: supabase_service_role_key,\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      },\n      {\n        key: 'NEXT_PUBLIC_APP_URL',\n        value: 'https://elevateconnectsdirectory.org',\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      },\n      {\n        key: 'NEXT_PUBLIC_SITE_URL',\n        value: 'https://elevateconnectsdirectory.org',\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      },\n      {\n        key: 'NODE_ENV',\n        value: 'production',\n        scopes: ['builds', 'functions', 'runtime', 'post_processing']\n      }\n    ];\n    \n    const results = [];\n    \n    // Add each environment variable\n    for (const envVar of envVars) {\n      try {\n        const response = await fetch(\n          `https://api.netlify.com/api/v1/sites/${SITE_ID}/env/${envVar.key}`,\n          {\n            method: 'PUT',\n            headers: {\n              'Authorization': `Bearer ${NETLIFY_TOKEN}`,\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n              context: 'all',\n              value: envVar.value,\n              scopes: envVar.scopes\n            })\n          }\n        );\n        \n        const result = await response.json();\n        results.push({\n          key: envVar.key,\n          status: response.ok ? 'success' : 'failed',\n          response: result\n        });\n      } catch (error) {\n        results.push({\n          key: envVar.key,\n          status: 'error',\n          error: error.message\n        });\n      }\n    }\n    \n    // Trigger deploy with cache clear\n    try {\n      const deployResponse = await fetch(\n        `https://api.netlify.com/api/v1/sites/${SITE_ID}/builds`,\n        {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${NETLIFY_TOKEN}`,\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ clear_cache: true })\n        }\n      );\n      \n      const deployResult = await deployResponse.json();\n      \n      return new Response(JSON.stringify({\n        success: true,\n        env_vars_added: results,\n        deploy_triggered: deployResponse.ok,\n        deploy_id: deployResult.id,\n        message: 'Environment variables added and deploy triggered'\n      }), {\n        headers: { 'Content-Type': 'application/json' }\n      });\n    } catch (error) {\n      return new Response(JSON.stringify({\n        success: false,\n        env_vars_added: results,\n        deploy_error: error.message\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n  }\n};"
  },
  "bash_script": {
    "description": "Alternative: Bash script to add env vars via curl",
    "filename": "scripts/add-netlify-env-vars.sh",
    "code": "#!/bin/bash\n\n# Add Netlify Environment Variables\n# Usage: ./scripts/add-netlify-env-vars.sh <service_role_key>\n\nset -e\n\nNETLIFY_TOKEN=\"${NETLIFY_AUTH_TOKEN:-nfp_ZQh1EUwZgJt939dcD3kb9sEYGk7DDgwPbaae}\"\nSITE_ID=\"12f120ab-3f63-419b-bc49-430f043415c1\"\nSUPABASE_URL=\"https://cuxzzpsyufcewtmicszk.supabase.co\"\nSUPABASE_ANON_KEY=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1eHp6cHN5dWZjZXd0bWljc3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA3MzI0NzUsImV4cCI6MjA0NjMwODQ3NX0.9y3VZ_pqLbHqEqGJYqxQxqxQxqxQxqxQxqxQxqxQxqxQ\"\nSUPABASE_SERVICE_ROLE_KEY=\"$1\"\n\nif [ -z \"$SUPABASE_SERVICE_ROLE_KEY\" ]; then\n  echo \"Error: Service role key required\"\n  echo \"Usage: $0 <service_role_key>\"\n  exit 1\nfi\n\necho \"Adding environment variables to Netlify...\"\n\n# Function to add env var\nadd_env_var() {\n  local key=$1\n  local value=$2\n  \n  echo \"Adding $key...\"\n  \n  curl -X PUT \\\n    \"https://api.netlify.com/api/v1/sites/${SITE_ID}/env/${key}\" \\\n    -H \"Authorization: Bearer ${NETLIFY_TOKEN}\" \\\n    -H \"Content-Type: application/json\" \\\n    -d \"{\n      \\\"context\\\": \\\"all\\\",\n      \\\"value\\\": \\\"${value}\\\",\n      \\\"scopes\\\": [\\\"builds\\\", \\\"functions\\\", \\\"runtime\\\", \\\"post_processing\\\"]\n    }\" \\\n    -s -o /dev/null -w \"Status: %{http_code}\\n\"\n}\n\n# Add all environment variables\nadd_env_var \"NEXT_PUBLIC_SUPABASE_URL\" \"$SUPABASE_URL\"\nadd_env_var \"NEXT_PUBLIC_SUPABASE_ANON_KEY\" \"$SUPABASE_ANON_KEY\"\nadd_env_var \"SUPABASE_SERVICE_ROLE_KEY\" \"$SUPABASE_SERVICE_ROLE_KEY\"\nadd_env_var \"NEXT_PUBLIC_APP_URL\" \"https://elevateconnectsdirectory.org\"\nadd_env_var \"NEXT_PUBLIC_SITE_URL\" \"https://elevateconnectsdirectory.org\"\nadd_env_var \"NODE_ENV\" \"production\"\n\necho \"\"\necho \"Triggering deploy with cache clear...\"\n\ncurl -X POST \\\n  \"https://api.netlify.com/api/v1/sites/${SITE_ID}/builds\" \\\n  -H \"Authorization: Bearer ${NETLIFY_TOKEN}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"clear_cache\": true}' \\\n  -s | jq '.id'\n\necho \"\"\necho \"✅ Environment variables added and deploy triggered!\"\necho \"Monitor deployment at: https://app.netlify.com/sites/${SITE_ID}/deploys\"\n"
  },
  "completion": {
    "message": "✅ Environment variables added to Netlify and deploy triggered!",
    "verification": [
      "Check Netlify dashboard for new environment variables",
      "Monitor deployment progress",
      "Verify site loads after deployment"
    ],
    "next_steps": [
      "Wait 2-3 minutes for deployment to complete",
      "Test site: https://elevateconnectsdirectory.org",
      "Verify Supabase connection works"
    ]
  },
  "usage_instructions": {
    "option_1_api": "Autopilot will use Netlify API to add variables automatically",
    "option_2_worker": "Deploy the Cloudflare Worker and POST Supabase keys to it",
    "option_3_bash": "Run: ./scripts/add-netlify-env-vars.sh <service_role_key>",
    "option_4_manual": "Follow FIX_DEPLOYMENT_NOW.md for manual setup"
  }
}
