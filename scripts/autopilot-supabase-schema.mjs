// scripts/autopilot-supabase-schema.mjs
// Autopilot: scan codebase for Supabase table usage and generate schema stubs

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT = path.resolve(__dirname, '..');
const OUTPUT_DIR = path.join(ROOT, 'supabase', 'autopilot-migrations');

const TABLE_REGEXES = [
  /\.from\(['"`]([a-zA-Z0-9_]+)['"`]\)/g,
  /supabase\.from\(['"`]([a-zA-Z0-9_]+)['"`]\)/g,
];

const RPC_REGEX = /\.rpc\(['"`]([a-zA-Z0-9_]+)['"`]/g;

const VALID_EXT = ['.ts', '.tsx', '.js', '.jsx'];

const ignoreDirs = new Set([
  'node_modules',
  '.git',
  '.next',
  'dist',
  'build',
  'supabase',
  '.archive',
  'deployment-ready',
  'workers',
  'scripts',
]);

function walk(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const files = [];

  for (const entry of entries) {
    if (entry.name.startsWith('.')) continue;
    const full = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      if (ignoreDirs.has(entry.name)) continue;
      files.push(...walk(full));
    } else {
      const ext = path.extname(entry.name);
      if (VALID_EXT.includes(ext)) files.push(full);
    }
  }
  return files;
}

function extractMatches(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');

  const tables = new Set();
  for (const regex of TABLE_REGEXES) {
    regex.lastIndex = 0;
    let match;
    while ((match = regex.exec(content)) !== null) {
      if (match[1]) tables.add(match[1]);
    }
  }

  const rpcs = new Set();
  RPC_REGEX.lastIndex = 0;
  let m;
  while ((m = RPC_REGEX.exec(content)) !== null) {
    if (m[1]) rpcs.add(m[1]);
  }

  return { tables, rpcs };
}

function generateTableStub(tableName) {
  const lines = [];
  lines.push(`-- Table: ${tableName}`);
  lines.push(`CREATE TABLE IF NOT EXISTS public.${tableName} (`);
  lines.push('    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,');
  lines.push('    -- TODO: Add actual columns based on code usage');
  lines.push('    created_at timestamptz DEFAULT now(),');
  lines.push('    updated_at timestamptz DEFAULT now()');
  lines.push(');');
  lines.push('');
  lines.push('-- Enable Row Level Security');
  lines.push(`ALTER TABLE public.${tableName} ENABLE ROW LEVEL SECURITY;`);
  lines.push('');
  lines.push(`-- TODO: Add RLS policies for ${tableName}`);
  lines.push('-- Example:');
  lines.push(`-- CREATE POLICY "Users can view their own ${tableName}"`);
  lines.push(`--     ON public.${tableName}`);
  lines.push('--     FOR SELECT');
  lines.push('--     USING (auth.uid() = user_id);');
  lines.push('');
  return lines.join('\n');
}

function generateRpcStub(rpcName) {
  const lines = [];
  lines.push(`-- RPC Function: ${rpcName}`);
  lines.push(`-- TODO: Implement function ${rpcName}`);
  lines.push('-- Example:');
  lines.push(`-- CREATE OR REPLACE FUNCTION public.${rpcName}(`);
  lines.push('--     param1 text,');
  lines.push('--     param2 integer');
  lines.push('-- )');
  lines.push('-- RETURNS json');
  lines.push('-- LANGUAGE plpgsql');
  lines.push('-- SECURITY DEFINER');
  lines.push('-- AS $$');
  lines.push('-- BEGIN');
  lines.push('--     -- Function implementation here');
  lines.push("--     RETURN json_build_object('success', true);");
  lines.push('-- END;');
  lines.push('-- $$;');
  lines.push('');
  return lines.join('\n');
}

function main() {
  console.log('ðŸ¤– Supabase Schema Guardian â€“ scanning codebase...');
  const files = walk(ROOT);

  console.log(`Found ${files.length} files to scan`);

  const allTables = new Set();
  const allRpcs = new Set();
  const tableUsage = new Map(); // Track which files use which tables

  for (const file of files) {
    const { tables, rpcs } = extractMatches(file);
    const relativePath = path.relative(ROOT, file);

    tables.forEach((t) => {
      allTables.add(t);
      if (!tableUsage.has(t)) {
        tableUsage.set(t, []);
      }
      tableUsage.get(t).push(relativePath);
    });

    rpcs.forEach((r) => allRpcs.add(r));
  }

  console.log(`Detected ${allTables.size} unique tables`);
  console.log(`Detected ${allRpcs.size} unique RPC functions`);

  if (allTables.size === 0 && allRpcs.size === 0) {
    console.log('No Supabase usage detected â€“ nothing to do.');
    return;
  }

  fs.mkdirSync(OUTPUT_DIR, { recursive: true });

  const timestamp = new Date()
    .toISOString()
    .replace(/[:.]/g, '-')
    .split('T')[0];
  const outFile = path.join(OUTPUT_DIR, `autopilot-schema-${timestamp}.sql`);

  const lines = [];
  lines.push('-- ============================================');
  lines.push('-- Autopilot-generated Supabase schema stubs');
  lines.push('-- ============================================');
  lines.push('-- Generated: ' + new Date().toISOString());
  lines.push('-- ');
  lines.push('-- IMPORTANT: Review and customize before applying!');
  lines.push('-- This file contains stub definitions based on code analysis.');
  lines.push('-- You must add actual columns, constraints, and policies.');
  lines.push('-- ');
  lines.push('-- To apply: Use Supabase CLI or dashboard SQL editor');
  lines.push('-- ============================================');
  lines.push('');

  const sortedTables = Array.from(allTables).sort();

  if (allTables.size > 0) {
    lines.push('-- ============================================');
    lines.push('-- TABLE DEFINITIONS');
    lines.push('-- ============================================');
    lines.push('');

    for (const table of sortedTables) {
      const usedIn = tableUsage.get(table) || [];
      lines.push(
        `-- Used in: ${usedIn.slice(0, 3).join(', ')}${usedIn.length > 3 ? ` (+${usedIn.length - 3} more)` : ''}`
      );
      lines.push(generateTableStub(table));
      lines.push('');
    }
  }

  if (allRpcs.size > 0) {
    lines.push('-- ============================================');
    lines.push('-- RPC FUNCTION STUBS');
    lines.push('-- ============================================');
    lines.push('');

    const sortedRpcs = Array.from(allRpcs).sort();
    for (const fn of sortedRpcs) {
      lines.push(generateRpcStub(fn));
      lines.push('');
    }
  }

  lines.push('-- ============================================');
  lines.push('-- END OF AUTOPILOT-GENERATED SCHEMA');
  lines.push('-- ============================================');

  fs.writeFileSync(outFile, lines.join('\n'), 'utf8');
  console.log(`âœ… Generated schema stub file: ${outFile}`);

  // Create a summary file
  const summaryFile = path.join(OUTPUT_DIR, 'README.md');
  const summary = [
    '# Autopilot-Generated Schema Stubs',
    '',
    'This directory contains SQL schema stubs automatically generated by the Supabase Schema Guardian.',
    '',
    '## What This Is',
    '',
    "The autopilot scans your codebase for Supabase table usage (`.from('table_name')`) and RPC calls (`.rpc('function_name')`), then generates SQL stub files for any tables or functions it finds.",
    '',
    '## How to Use',
    '',
    '1. **Review** the generated SQL files',
    '2. **Customize** table definitions with actual columns',
    '3. **Add** appropriate RLS policies',
    '4. **Apply** via Supabase CLI or dashboard',
    '',
    '## Detected Tables',
    '',
    ...sortedTables.map(
      (t) => `- \`${t}\` - Used in ${tableUsage.get(t).length} file(s)`
    ),
    '',
    '## Detected RPC Functions',
    '',
    ...Array.from(allRpcs)
      .sort()
      .map((r) => `- \`${r}\``),
    '',
    '## Applying Migrations',
    '',
    '### Option 1: Supabase CLI',
    '```bash',
    'supabase db push',
    '```',
    '',
    '### Option 2: Supabase Dashboard',
    '1. Go to SQL Editor in Supabase dashboard',
    '2. Copy and paste the SQL from generated files',
    '3. Review and execute',
    '',
    '### Option 3: Direct psql',
    '```bash',
    'psql $DATABASE_URL < supabase/autopilot-migrations/autopilot-schema-*.sql',
    '```',
    '',
    '## Important Notes',
    '',
    '- âš ï¸ **Always review before applying** - these are stubs, not complete schemas',
    '- âš ï¸ **Add proper columns** - the generated tables only have `id`, `created_at`, `updated_at`',
    '- âš ï¸ **Configure RLS** - security policies are commented out and must be customized',
    '- âš ï¸ **Test thoroughly** - verify your application works with the new schema',
    '',
    '---',
    '',
    `Last generated: ${new Date().toISOString()}`,
  ].join('\n');

  fs.writeFileSync(summaryFile, summary, 'utf8');
  console.log(`âœ… Generated summary: ${summaryFile}`);
}

main();
