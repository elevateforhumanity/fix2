#!/usr/bin/env node
/**
 * Elevate for Humanity SEO Autopilot (No API Keys Required)
 * Goal: Continuous SEO self-optimization to reach #1 ranking for Indiana WIOA / workforce funding searches
 * Runs daily via CRON, GitHub Action, or Supabase function
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// === CONFIG ===
const SITE_URL = 'https://www.elevateforhumanity.org';
const SITE_NAME = 'Elevate for Humanity Career & Technical Institute';
const TARGET_KEYWORDS = [
  'Indiana WIOA training provider',
  'ETPL approved programs Indiana',
  'Workforce funding apprenticeship Indianapolis',
  'Career Technical Institute Marion County',
  'State funded training provider Indiana',
  'Indiana workforce development',
  'WIOA eligible training programs',
  'Indianapolis career training',
  'Federal apprenticeship programs Indiana',
  'Workforce Innovation Opportunity Act Indiana',
];

const META_DESC =
  'Elevate for Humanity Career & Technical Institute empowers Indiana residents with WIOA-funded training, apprenticeships, and workforce certifications through state and federal partnerships.';

const STRUCTURED_DATA = {
  '@context': 'https://schema.org',
  '@type': 'EducationalOrganization',
  name: SITE_NAME,
  url: SITE_URL,
  logo: `${SITE_URL}/assets/logo.png`,
  description: META_DESC,
  address: {
    '@type': 'PostalAddress',
    addressLocality: 'Indianapolis',
    addressRegion: 'IN',
    addressCountry: 'US',
  },
  areaServed: {
    '@type': 'State',
    name: 'Indiana',
  },
  offers: {
    '@type': 'Offer',
    category: 'Career Training',
    availability: 'https://schema.org/InStock',
  },
};

console.log('ğŸš€ Running Elevate SEO Autopilot (No API Keys Required)...\n');

// === STEP 1: Analyze current site ===
function analyzeSite() {
  console.log('ğŸ” Analyzing site structure...');

  const indexPath = './index.html';
  const distIndexPath = './dist/index.html';

  let html = '';
  let targetPath = '';

  if (fs.existsSync(distIndexPath)) {
    html = fs.readFileSync(distIndexPath, 'utf8');
    targetPath = distIndexPath;
  } else if (fs.existsSync(indexPath)) {
    html = fs.readFileSync(indexPath, 'utf8');
    targetPath = indexPath;
  } else {
    console.error('âŒ No index.html found');
    return null;
  }

  const hasTitle = /<title>/.test(html);
  const hasMetaDesc = /<meta name="description"/.test(html);
  const hasOG = /<meta property="og:/.test(html);
  const hasStructuredData = /<script type="application\/ld\+json">/.test(html);
  const hasKeywords = TARGET_KEYWORDS.some((k) =>
    html.toLowerCase().includes(k.toLowerCase())
  );

  console.log('  Title tag:', hasTitle ? 'âœ…' : 'âŒ');
  console.log('  Meta description:', hasMetaDesc ? 'âœ…' : 'âŒ');
  console.log('  Open Graph tags:', hasOG ? 'âœ…' : 'âŒ');
  console.log('  Structured data:', hasStructuredData ? 'âœ…' : 'âŒ');
  console.log('  Target keywords:', hasKeywords ? 'âœ…' : 'âš ï¸  Partial');
  console.log('');

  return { html, targetPath, hasTitle, hasMetaDesc, hasOG, hasStructuredData };
}

// === STEP 2: Generate optimized meta tags ===
function generateSEOHead() {
  const keywordString = TARGET_KEYWORDS.join(', ');

  return `
  <!-- SEO Meta Tags - Auto-generated by SEO Autopilot -->
  <title>Indiana WIOA Training Provider | ${SITE_NAME}</title>
  <meta name="description" content="${META_DESC}" />
  <meta name="keywords" content="${keywordString}" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="${SITE_URL}" />
  <meta property="og:title" content="${SITE_NAME} - Indiana Workforce Training" />
  <meta property="og:description" content="${META_DESC}" />
  <meta property="og:image" content="${SITE_URL}/assets/og-image.png" />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="${SITE_URL}" />
  <meta property="twitter:title" content="${SITE_NAME} - Indiana Workforce Training" />
  <meta property="twitter:description" content="${META_DESC}" />
  <meta property="twitter:image" content="${SITE_URL}/assets/og-image.png" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="${SITE_URL}" />
  
  <!-- Robots -->
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
  
  <!-- Structured Data -->
  <script type="application/ld+json">
${JSON.stringify(STRUCTURED_DATA, null, 2)}
  </script>
`;
}

// === STEP 3: Inject optimized head into HTML files ===
function injectSEO() {
  console.log('ğŸ’‰ Injecting SEO optimizations...');

  const analysis = analyzeSite();
  if (!analysis) return;

  const { html, targetPath } = analysis;
  const newHead = generateSEOHead();

  // Find the head section and inject/update
  let updated = html;

  // Remove old SEO tags if they exist
  updated = updated.replace(/<!-- SEO Meta Tags.*?<\/script>/gs, '');

  // Inject new SEO tags before </head>
  if (updated.includes('</head>')) {
    updated = updated.replace('</head>', `${newHead}\n  </head>`);
  } else {
    console.warn('âš ï¸  No </head> tag found, appending to top');
    updated = newHead + updated;
  }

  fs.writeFileSync(targetPath, updated);
  console.log(`  âœ… Updated: ${targetPath}`);

  // Also update dist if different from source
  if (
    targetPath !== './dist/index.html' &&
    fs.existsSync('./dist/index.html')
  ) {
    const distHtml = fs.readFileSync('./dist/index.html', 'utf8');
    let distUpdated = distHtml.replace(/<!-- SEO Meta Tags.*?<\/script>/gs, '');
    distUpdated = distUpdated.replace('</head>', `${newHead}\n  </head>`);
    fs.writeFileSync('./dist/index.html', distUpdated);
    console.log('  âœ… Updated: ./dist/index.html');
  }

  console.log('');
}

// === STEP 4: Generate sitemap + robots.txt ===
function generateSitemap() {
  console.log('ğŸ—ºï¸  Generating sitemap and robots.txt...');

  const pages = [
    { url: '', priority: '1.0', changefreq: 'daily' },
    { url: 'programs', priority: '0.9', changefreq: 'weekly' },
    { url: 'courses', priority: '0.9', changefreq: 'weekly' },
    { url: 'funding', priority: '0.8', changefreq: 'monthly' },
    { url: 'apprenticeships', priority: '0.8', changefreq: 'monthly' },
    { url: 'apply', priority: '0.9', changefreq: 'monthly' },
    { url: 'contact', priority: '0.7', changefreq: 'monthly' },
    { url: 'about', priority: '0.7', changefreq: 'monthly' },
    { url: 'employers', priority: '0.8', changefreq: 'monthly' },
    { url: 'federal-apprenticeships', priority: '0.8', changefreq: 'monthly' },
  ];

  const now = new Date().toISOString().split('T')[0];

  const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml"
        xmlns:mobile="http://www.google.com/schemas/sitemap-mobile/1.0"
        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"
        xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">
${pages
  .map(
    (p) => `  <url>
    <loc>${SITE_URL}/${p.url}</loc>
    <lastmod>${now}</lastmod>
    <changefreq>${p.changefreq}</changefreq>
    <priority>${p.priority}</priority>
  </url>`
  )
  .join('\n')}
</urlset>`;

  const robotsTxt = `# Elevate for Humanity - Robots.txt
User-agent: *
Allow: /
Disallow: /api/
Disallow: /admin/
Disallow: /*.json$

# Sitemaps
Sitemap: ${SITE_URL}/sitemap.xml
Sitemap: ${SITE_URL}/sitemap-static.xml

# Crawl-delay for aggressive bots
User-agent: AhrefsBot
Crawl-delay: 10

User-agent: SemrushBot
Crawl-delay: 10

# Block AI scrapers (optional - remove if you want AI training)
User-agent: GPTBot
Disallow: /

User-agent: ChatGPT-User
Disallow: /

User-agent: CCBot
Disallow: /

User-agent: anthropic-ai
Disallow: /

User-agent: Claude-Web
Disallow: /
`;

  // Write to public and dist
  const targets = ['./public', './dist'];

  targets.forEach((dir) => {
    if (fs.existsSync(dir)) {
      fs.writeFileSync(path.join(dir, 'sitemap.xml'), sitemap);
      fs.writeFileSync(path.join(dir, 'robots.txt'), robotsTxt);
      console.log(`  âœ… Generated sitemap.xml and robots.txt in ${dir}`);
    }
  });

  console.log('');
}

// === STEP 5: Generate SEO report (no API calls) ===
function generateSEOReport() {
  console.log('ğŸ“Š Generating SEO report...');

  const analysis = analyzeSite();
  if (!analysis) return;

  const score = [
    analysis.hasTitle ? 20 : 0,
    analysis.hasMetaDesc ? 20 : 0,
    analysis.hasOG ? 20 : 0,
    analysis.hasStructuredData ? 20 : 0,
    fs.existsSync('./public/sitemap.xml') || fs.existsSync('./dist/sitemap.xml')
      ? 20
      : 0,
  ].reduce((a, b) => a + b, 0);

  const report = {
    timestamp: new Date().toISOString(),
    score: score,
    maxScore: 100,
    grade:
      score >= 90
        ? 'A'
        : score >= 80
          ? 'B'
          : score >= 70
            ? 'C'
            : score >= 60
              ? 'D'
              : 'F',
    checks: {
      titleTag: analysis.hasTitle,
      metaDescription: analysis.hasMetaDesc,
      openGraph: analysis.hasOG,
      structuredData: analysis.hasStructuredData,
      sitemap:
        fs.existsSync('./public/sitemap.xml') ||
        fs.existsSync('./dist/sitemap.xml'),
      robotsTxt:
        fs.existsSync('./public/robots.txt') ||
        fs.existsSync('./dist/robots.txt'),
    },
    targetKeywords: TARGET_KEYWORDS,
    recommendations: [],
  };

  if (!analysis.hasTitle)
    report.recommendations.push('Add optimized title tag');
  if (!analysis.hasMetaDesc)
    report.recommendations.push('Add meta description');
  if (!analysis.hasOG) report.recommendations.push('Add Open Graph tags');
  if (!analysis.hasStructuredData)
    report.recommendations.push('Add structured data (Schema.org)');
  if (!report.checks.sitemap)
    report.recommendations.push('Generate sitemap.xml');
  if (!report.checks.robotsTxt)
    report.recommendations.push('Generate robots.txt');

  fs.writeFileSync('./seo-report.json', JSON.stringify(report, null, 2));

  console.log(`  SEO Score: ${score}/100 (Grade: ${report.grade})`);
  console.log(`  âœ… Report saved to: seo-report.json`);
  console.log('');

  return report;
}

// === STEP 6: Create submission URLs (no API calls needed) ===
function generateSubmissionGuide() {
  console.log('ğŸ”— Generating search engine submission guide...');

  const guide = `# Search Engine Submission Guide

## Automatic Submission (No API Keys Required)

### Google Search Console
1. Go to: https://search.google.com/search-console
2. Add property: ${SITE_URL}
3. Verify ownership (HTML file or DNS)
4. Submit sitemap: ${SITE_URL}/sitemap.xml

### Bing Webmaster Tools
1. Go to: https://www.bing.com/webmasters
2. Add site: ${SITE_URL}
3. Verify ownership
4. Submit sitemap: ${SITE_URL}/sitemap.xml

### Manual Ping URLs (Open in Browser)
- Google: https://www.google.com/ping?sitemap=${SITE_URL}/sitemap.xml
- Bing: https://www.bing.com/ping?sitemap=${SITE_URL}/sitemap.xml

### IndexNow (Instant Indexing - No API Key)
\`\`\`bash
curl -X POST "https://api.indexnow.org/indexnow" \\
  -H "Content-Type: application/json" \\
  -d '{
    "host": "www.elevateforhumanity.org",
    "key": "generate-a-random-key-here",
    "keyLocation": "${SITE_URL}/indexnow-key.txt",
    "urlList": [
      "${SITE_URL}",
      "${SITE_URL}/programs",
      "${SITE_URL}/courses"
    ]
  }'
\`\`\`

## Local SEO (No API Keys)

### Google Business Profile
1. Go to: https://business.google.com
2. Create/claim business listing
3. Add: ${SITE_NAME}
4. Category: Career Counseling, Training Center
5. Add photos, hours, description

### Bing Places
1. Go to: https://www.bingplaces.com
2. Add business listing
3. Link to website: ${SITE_URL}

## Directory Submissions (Free)

1. **Indiana Workforce Development**: https://www.in.gov/dwd/
2. **WIOA Provider Directory**: Contact local workforce board
3. **CareerOneStop**: https://www.careeronestop.org
4. **Training Provider Registry**: State-specific registration

## Social Signals (Free)

1. Share on LinkedIn, Facebook, Twitter
2. Create Google Business posts weekly
3. Encourage reviews on Google
4. Build backlinks from .gov and .edu sites

## Monitoring (No API Keys)

- Google Search Console: Track rankings, clicks, impressions
- Bing Webmaster Tools: Same for Bing
- Google Analytics: Add tracking code (free)
- Google Business Insights: Track local searches

## Next Steps

1. âœ… Run this script weekly: \`npm run seo:optimize\`
2. âœ… Submit sitemap to Google & Bing
3. âœ… Create Google Business Profile
4. âœ… Get listed in WIOA provider directory
5. âœ… Build backlinks from Indiana workforce sites
6. âœ… Create content targeting keywords: ${TARGET_KEYWORDS.slice(0, 3).join(', ')}

## Automated Monitoring Script

\`\`\`bash
# Add to crontab for weekly runs
0 0 * * 0 cd /path/to/project && npm run seo:optimize
\`\`\`
`;

  fs.writeFileSync('./SEO_SUBMISSION_GUIDE.md', guide);
  console.log('  âœ… Created: SEO_SUBMISSION_GUIDE.md');
  console.log('');
}

// === MAIN EXECUTION ===
(async () => {
  try {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('  Elevate for Humanity - SEO Autopilot');
    console.log('  No API Keys Required | 100% Free');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    injectSEO();
    generateSitemap();
    const report = generateSEOReport();
    generateSubmissionGuide();

    console.log('ğŸ¯ SEO Optimization Complete!\n');
    console.log('Next Steps:');
    console.log('  1. Review: seo-report.json');
    console.log('  2. Read: SEO_SUBMISSION_GUIDE.md');
    console.log('  3. Submit sitemap to Google & Bing');
    console.log('  4. Run weekly: npm run seo:optimize\n');

    if (report && report.score < 100) {
      console.log('âš ï¸  Recommendations:');
      report.recommendations.forEach((rec) => console.log(`  - ${rec}`));
      console.log('');
    }

    console.log('âœ… All done! Your site is now optimized for search engines.');
  } catch (error) {
    console.error('âŒ Error:', error.message);
    process.exit(1);
  }
})();
