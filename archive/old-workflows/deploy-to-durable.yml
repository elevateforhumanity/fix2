name: Deploy Enrollment Programs to Durable

on:
  workflow_dispatch:
  push:
    paths:
      - '.autopilot-durable-task.json'
      - 'DURABLE_ENROLLMENT_CODE.html'

jobs:
  deploy-to-durable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Run Durable Autopilot
        env:
          DURABLE_EMAIL: ${{ secrets.DURABLE_EMAIL }}
          DURABLE_PASSWORD: ${{ secrets.DURABLE_PASSWORD }}
        run: |
          echo "ðŸ¤– Starting Durable Autopilot..."
          chmod +x durable

          # Try each method until one succeeds
          ./durable workers && echo "âœ… Workers method succeeded!" && exit 0
          ./durable regenerate && echo "âœ… Regenerate method succeeded!" && exit 0
          ./durable ai && echo "âœ… AI method succeeded!" && exit 0
          ./durable manual && echo "âœ… Manual method succeeded!" && exit 0

          echo "âŒ All methods failed"
          exit 1

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          curl -s https://www.elevateforhumanity.org | grep -q "Enroll in Our Programs" && echo "âœ… Verified!" || echo "âš ï¸ Not found yet"

      - name: Create Success Report
        if: success()
        run: |
          echo "# âœ… Deployment Successful" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Time**: $(date)" >> deployment-report.md
          echo "**Target**: https://www.elevateforhumanity.org" >> deployment-report.md
          echo "**Programs Deployed**: 6 enrollment programs" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "Visit: https://www.elevateforhumanity.org" >> deployment-report.md

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: |
            deployment-report.md
            logs/*.png
