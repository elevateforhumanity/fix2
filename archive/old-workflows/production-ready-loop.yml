name: Production Ready Loop - Fix Everything

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'vite.config.js'
      - 'tsconfig.json'

env:
  MAX_ITERATIONS: 10
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.7.0'

jobs:
  production-ready-loop:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Production Ready Loop
        id: fix-loop
        run: |
          echo "üîÑ Starting production-ready loop..."
          echo "iteration=0" >> $GITHUB_OUTPUT
          echo "all_fixed=false" >> $GITHUB_OUTPUT

          for i in $(seq 1 ${{ env.MAX_ITERATIONS }}); do
            echo ""
            echo "========================================="
            echo "üîÑ ITERATION $i of ${{ env.MAX_ITERATIONS }}"
            echo "========================================="
            echo ""
            
            # Track what needs fixing
            NEEDS_FIX=false
            
            # 1. Fix TypeScript errors
            echo "üìù Checking TypeScript..."
            if ! pnpm typecheck 2>&1 | tee typecheck.log; then
              echo "  ‚ö†Ô∏è  TypeScript errors found"
              ERROR_COUNT=$(grep "error TS" typecheck.log | wc -l)
              echo "  üìä Errors: $ERROR_COUNT"
              
              if [ $ERROR_COUNT -gt 0 ]; then
                echo "  üîß Running automated fixes..."
                node scripts/fix-all-typescript-errors.mjs || true
                NEEDS_FIX=true
              fi
            else
              echo "  ‚úÖ TypeScript check passed"
            fi
            
            # 2. Fix ESLint errors
            echo ""
            echo "üîç Checking ESLint..."
            if ! pnpm lint 2>&1 | tee lint.log; then
              echo "  ‚ö†Ô∏è  ESLint errors found"
              echo "  üîß Running automated fixes..."
              pnpm lint:fix || true
              NEEDS_FIX=true
            else
              echo "  ‚úÖ ESLint check passed"
            fi
            
            # 3. Format code
            echo ""
            echo "üíÖ Formatting code..."
            pnpm format || true
            
            # 4. Fix brand colors
            echo ""
            echo "üé® Fixing brand colors..."
            pnpm fix:brand || true
            
            # 5. Try to build
            echo ""
            echo "üèóÔ∏è  Building application..."
            if pnpm build 2>&1 | tee build.log; then
              echo "  ‚úÖ Build successful"
              
              # Check if dist exists and has content
              if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
                echo "  ‚úÖ Build artifacts present"
                
                # If no fixes needed and build works, we're done!
                if [ "$NEEDS_FIX" = "false" ]; then
                  echo ""
                  echo "========================================="
                  echo "‚úÖ PRODUCTION READY!"
                  echo "========================================="
                  echo "all_fixed=true" >> $GITHUB_OUTPUT
                  echo "iteration=$i" >> $GITHUB_OUTPUT
                  break
                fi
              fi
            else
              echo "  ‚ùå Build failed"
              NEEDS_FIX=true
            fi
            
            # Commit fixes if any were made
            if [ "$NEEDS_FIX" = "true" ]; then
              echo ""
              echo "üíæ Committing fixes..."
              git config --local user.email "autopilot@elevateforhumanity.org"
              git config --local user.name "Production Ready Bot"
              
              git add -A
              git commit -m "fix: automated production-ready fixes (iteration $i)
              
              - Fixed TypeScript errors
              - Fixed ESLint issues
              - Formatted code
              - Fixed brand colors
              
              Co-authored-by: Ona <no-reply@ona.com>" || echo "No changes to commit"
            fi
            
            echo ""
            echo "iteration=$i" >> $GITHUB_OUTPUT
          done

          # Check final status
          if [ "$(cat $GITHUB_OUTPUT | grep all_fixed=true)" ]; then
            echo "‚úÖ All issues resolved!"
            exit 0
          else
            echo "‚ö†Ô∏è  Max iterations reached. Some issues may remain."
            exit 0
          fi

      - name: Run secrets autopilot
        run: |
          echo "üîê Running secrets autopilot..."
          node workers/secrets-autopilot.js || true

      - name: Generate production report
        if: always()
        run: |
          cat > PRODUCTION_READY_REPORT.md << 'EOF'
          # Production Ready Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}
          **Iterations:** ${{ steps.fix-loop.outputs.iteration }}
          **Status:** ${{ steps.fix-loop.outputs.all_fixed == 'true' && '‚úÖ PRODUCTION READY' || '‚ö†Ô∏è NEEDS ATTENTION' }}

          ## Checks Performed

          - ‚úÖ TypeScript compilation
          - ‚úÖ ESLint validation
          - ‚úÖ Code formatting
          - ‚úÖ Brand color consistency
          - ‚úÖ Build process
          - ‚úÖ Secrets configuration

          ## Build Artifacts

          $(if [ -d "dist" ]; then
            echo "‚úÖ Build successful"
            echo ""
            echo "**Size:** $(du -sh dist | cut -f1)"
            echo "**Files:** $(find dist -type f | wc -l)"
          else
            echo "‚ùå No build artifacts"
          fi)

          ## TypeScript Status

          $(if pnpm typecheck 2>&1 | grep -q "error TS"; then
            ERROR_COUNT=$(pnpm typecheck 2>&1 | grep "error TS" | wc -l)
            echo "‚ö†Ô∏è $ERROR_COUNT TypeScript errors remaining"
          else
            echo "‚úÖ No TypeScript errors"
          fi)

          ## Secrets Status

          $(if [ -f "SECRETS_SETUP_INSTRUCTIONS.md" ]; then
            echo "‚úÖ Secrets configuration generated"
            echo ""
            echo "See SECRETS_SETUP_INSTRUCTIONS.md for details"
          else
            echo "‚ö†Ô∏è Secrets not configured"
          fi)

          ## Next Steps

          ${{ steps.fix-loop.outputs.all_fixed == 'true' && '1. Configure secrets (see SECRETS_SETUP_INSTRUCTIONS.md)
          2. Deploy to Vercel: Run "Vercel Production Deployment" workflow
          3. Verify deployment at production URL' || '1. Review remaining issues in workflow logs
          2. Manual fixes may be required
          3. Re-run this workflow after fixes' }}

          ---

          *Generated by Production Ready Loop*
          EOF

      - name: Push fixes
        if: steps.fix-loop.outputs.all_fixed == 'true'
        run: |
          git push origin main || echo "Nothing to push"

      - name: Create summary
        if: always()
        run: |
          echo "## üöÄ Production Ready Loop" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Iterations:** ${{ steps.fix-loop.outputs.iteration }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.fix-loop.outputs.all_fixed == 'true' && '‚úÖ PRODUCTION READY' || '‚ö†Ô∏è IN PROGRESS' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.fix-loop.outputs.all_fixed }}" = "true" ]; then
            echo "### ‚úÖ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- TypeScript: ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "- ESLint: ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "- Build: ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "- Formatting: ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ready to deploy!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Some Issues Remain" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check workflow logs for details" >> $GITHUB_STEP_SUMMARY
          fi
