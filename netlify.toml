[build]
  command = "rm -rf dist node_modules/.vite && pnpm install && pnpm run build"
  publish = "dist"
  functions = "netlify/functions"
  ignore = "git diff --quiet $CACHED_COMMIT_REF $COMMIT_REF ."

[build.environment]
  NODE_VERSION = "20.11.1"
  PNPM_VERSION = "9.7.0"
  NODE_OPTIONS = "--max_old_space_size=4096"
  CI = "true"
  GENERATE_SOURCEMAP = "false"
  VITE_BUILD_ID = "$COMMIT_REF"
  VITE_SUPABASE_URL = "https://cuxzzpsyufcewtmicszk.supabase.co"
  VITE_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1eHp6cHN5dWZjZXd0bWljc3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjEwNDcsImV4cCI6MjA3MzczNzA0N30.DyFtzoKha_tuhKiSIPoQlKonIpaoSYrlhzntCUvLUnA"
  VITE_STRIPE_PUBLISHABLE_KEY = "pk_live_51RvqjzIRNf5vPH3ABuHQofarfuWw0PW5ww9eTwkj21A6VLJaLopuYbPdpAFCTU10O5uLgGHeCTBEcu9xeM8ErbFy004j2KPoSx"

# Production context: main branch deploys
[context.production]
  command = "pnpm install && NODE_ENV=production pnpm run build"
  publish = "dist"

# Deploy Preview context: pull request deploys
[context.deploy-preview]
  command = "pnpm install --frozen-lockfile && pnpm run build"
  publish = "dist"
  [context.deploy-preview.environment]
    NODE_ENV = "development"

# Branch deploy context: all other branches
[context.branch-deploy]
  command = "pnpm install --frozen-lockfile && pnpm run build"
  publish = "dist"
  [context.branch-deploy.environment]
    NODE_ENV = "development"

# Prevent preview deployments from being indexed
[[headers]]
  for = "/*"
  [headers.values]
    X-Robots-Tag = "noindex, nofollow"
  [headers.context]
    branch-deploy = true
    deploy-preview = true

# Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  # Increase timeout for AI/API operations
  [functions."*"]
    timeout = 30

# Netlify Plugins
# Disabled due to puppeteer module compatibility issue
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"
#   [plugins.inputs]
#     output_path = "reports/lighthouse.html"

# Disabled - causing cache resolution errors
# [[plugins]]
#   package = "netlify-plugin-cache"
#   [plugins.inputs]
#     paths = ["node_modules", ".pnpm-store"]

# Disabled due to plugin error
# [[plugins]]
#   package = "netlify-plugin-checklinks"
#   [plugins.inputs]
#     skipPatterns = ["/api/*", "*.pdf"]
#     todoPatterns = []

[[plugins]]
  package = "netlify-plugin-submit-sitemap"
  [plugins.inputs]
    baseUrl = "https://elevateforhumanityfix2.netlify.app"
    sitemapPath = "/sitemap.xml"
    providers = ["google", "bing"]

# Note: Supabase integration should be enabled via Netlify Dashboard
# Go to: https://app.netlify.com/sites/elevateforhumanityfix2/integrations
# Search for "Supabase" and enable it there

# No domain redirects - deploying to elevateforhumanityfix2.netlify.app

# API function redirects
[[redirects]]
  from = "/api/automated-reporting"
  to = "/.netlify/functions/automated-reporting"
  status = 200

[[redirects]]
  from = "/api/create-checkout-session"
  to = "/.netlify/functions/create-checkout-session"
  status = 200

[[redirects]]
  from = "/api/create-donation-session"
  to = "/.netlify/functions/create-donation-session"
  status = 200

[[redirects]]
  from = "/api/create-enrollment-session"
  to = "/.netlify/functions/create-enrollment-session"
  status = 200

[[redirects]]
  from = "/api/enrollment-sync"
  to = "/.netlify/functions/enrollment-sync"
  status = 200

[[redirects]]
  from = "/api/generate-content-calendar"
  to = "/.netlify/functions/generate-content-calendar"
  status = 200

[[redirects]]
  from = "/api/generate-social-content"
  to = "/.netlify/functions/generate-social-content"
  status = 200

[[redirects]]
  from = "/api/health-check"
  to = "/.netlify/functions/health-check"
  status = 200

[[redirects]]
  from = "/api/health-db"
  to = "/.netlify/functions/health-db"
  status = 200

[[redirects]]
  from = "/api/job-placement-tracking"
  to = "/.netlify/functions/job-placement-tracking"
  status = 200

[[redirects]]
  from = "/api/post-scheduled-content"
  to = "/.netlify/functions/post-scheduled-content"
  status = 200

[[redirects]]
  from = "/api/post-to-social-media"
  to = "/.netlify/functions/post-to-social-media"
  status = 200

[[redirects]]
  from = "/api/sentry-webhook"
  to = "/.netlify/functions/sentry-webhook"
  status = 200

[[redirects]]
  from = "/api/stripe-connect-onboarding"
  to = "/.netlify/functions/stripe-connect-onboarding"
  status = 200

[[redirects]]
  from = "/api/stripe-split-payout"
  to = "/.netlify/functions/stripe-split-payout"
  status = 200

[[redirects]]
  from = "/api/stripe-webhook"
  to = "/.netlify/functions/stripe-webhook"
  status = 200

[[redirects]]
  from = "/api/submit-scholarship-application"
  to = "/.netlify/functions/submit-scholarship-application"
  status = 200

[[redirects]]
  from = "/api/public/programs.json"
  to = "/.netlify/functions/programs"
  status = 200

[[redirects]]
  from = "/api/public/courses.json"
  to = "/.netlify/functions/courses"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cuxzzpsyufcewtmicszk.supabase.co https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://cuxzzpsyufcewtmicszk.supabase.co wss://cuxzzpsyufcewtmicszk.supabase.co https://api.stripe.com; frame-src https://js.stripe.com https://hooks.stripe.com; frame-ancestors 'none'"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    X-Frame-Options = "SAMEORIGIN"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
    X-Robots-Tag = "noai, noimageai"
