# Vite/React Site Configuration
[build]
  command = "npm install && npm run build"
  publish = "dist"

[build.environment]
  NODE_VERSION = "20.11.1"
  NODE_OPTIONS = "--max_old_space_size=4096"
  # Environment variables set via Netlify UI or API
  # VITE_API_URL
  # VITE_SUPABASE_URL
  # VITE_SUPABASE_ANON_KEY
  # VITE_STRIPE_PUBLISHABLE_KEY

# Production context: main branch deploys
[context.production]
  command = "npm install && npm run build"
  publish = "dist"

# Deploy Preview context: pull request deploys
[context.deploy-preview]
  command = "pnpm install --frozen-lockfile && pnpm run build"
  publish = "dist"
  [context.deploy-preview.environment]
    NODE_ENV = "development"

# Branch deploy context: all other branches
[context.branch-deploy]
  command = "pnpm install --frozen-lockfile && pnpm run build"
  publish = "dist"
  [context.branch-deploy.environment]
    NODE_ENV = "development"

# Prevent preview deployments from being indexed
[[headers]]
  for = "/*"
  [headers.values]
    X-Robots-Tag = "noindex, nofollow"
  [headers.context]
    branch-deploy = true
    deploy-preview = true

# Functions configuration
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  # Increase timeout for AI/API operations
  [functions."*"]
    timeout = 30

# Netlify Plugins
# Disabled due to puppeteer module compatibility issue
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"
#   [plugins.inputs]
#     output_path = "reports/lighthouse.html"

# Disabled - causing cache resolution errors
# [[plugins]]
#   package = "netlify-plugin-cache"
#   [plugins.inputs]
#     paths = ["node_modules", ".pnpm-store"]

# Disabled due to plugin error
# [[plugins]]
#   package = "netlify-plugin-checklinks"
#   [plugins.inputs]
#     skipPatterns = ["/api/*", "*.pdf"]
#     todoPatterns = []

[[plugins]]
  package = "netlify-plugin-submit-sitemap"
  [plugins.inputs]
    baseUrl = "https://portal.elevateforhumanity.org"
    sitemapPath = "/sitemap.xml"
    providers = ["google", "bing"]

[[plugins]]
  package = "@netlify/plugin-prerender"
  [plugins.inputs]
    routes = ["/", "/programs", "/about", "/support", "/community", "/connect"]

# Note: Supabase integration should be enabled via Netlify Dashboard
# Go to: https://app.netlify.com/sites/elevateforhumanityfix2/integrations
# Search for "Supabase" and enable it there

# Custom domain: portal.elevateforhumanity.org
# Main site (elevateforhumanity.org) hosted on Durable.co with "Get Started" button linking here

# Static API files - serve directly (must come BEFORE function redirects)
[[redirects]]
  from = "/api/efh-config.json"
  to = "/api/efh-config.json"
  status = 200
  force = false

[[redirects]]
  from = "/api/programs.json"
  to = "/api/programs.json"
  status = 200
  force = false

[[redirects]]
  from = "/api/partnerships.json"
  to = "/api/partnerships.json"
  status = 200
  force = false

[[redirects]]
  from = "/api/stats.json"
  to = "/api/stats.json"
  status = 200
  force = false

[[redirects]]
  from = "/api/health.json"
  to = "/api/health.json"
  status = 200
  force = false

# API function redirects
[[redirects]]
  from = "/api/automated-reporting"
  to = "/.netlify/functions/automated-reporting"
  status = 200

[[redirects]]
  from = "/api/create-checkout-session"
  to = "/.netlify/functions/create-checkout-session"
  status = 200

[[redirects]]
  from = "/api/create-donation-session"
  to = "/.netlify/functions/create-donation-session"
  status = 200

[[redirects]]
  from = "/api/create-enrollment-session"
  to = "/.netlify/functions/create-enrollment-session"
  status = 200

[[redirects]]
  from = "/api/enrollment-sync"
  to = "/.netlify/functions/enrollment-sync"
  status = 200

[[redirects]]
  from = "/api/generate-content-calendar"
  to = "/.netlify/functions/generate-content-calendar"
  status = 200

[[redirects]]
  from = "/api/generate-social-content"
  to = "/.netlify/functions/generate-social-content"
  status = 200

[[redirects]]
  from = "/api/health-check"
  to = "/.netlify/functions/health-check"
  status = 200

[[redirects]]
  from = "/api/health-db"
  to = "/.netlify/functions/health-db"
  status = 200

[[redirects]]
  from = "/api/job-placement-tracking"
  to = "/.netlify/functions/job-placement-tracking"
  status = 200

[[redirects]]
  from = "/api/post-scheduled-content"
  to = "/.netlify/functions/post-scheduled-content"
  status = 200

[[redirects]]
  from = "/api/post-to-social-media"
  to = "/.netlify/functions/post-to-social-media"
  status = 200

[[redirects]]
  from = "/api/sentry-webhook"
  to = "/.netlify/functions/sentry-webhook"
  status = 200

[[redirects]]
  from = "/api/stripe-connect-onboarding"
  to = "/.netlify/functions/stripe-connect-onboarding"
  status = 200

[[redirects]]
  from = "/api/stripe-split-payout"
  to = "/.netlify/functions/stripe-split-payout"
  status = 200

[[redirects]]
  from = "/api/stripe-webhook"
  to = "/.netlify/functions/stripe-webhook"
  status = 200

[[redirects]]
  from = "/api/submit-scholarship-application"
  to = "/.netlify/functions/submit-scholarship-application"
  status = 200

[[redirects]]
  from = "/api/public/programs.json"
  to = "/.netlify/functions/programs"
  status = 200

[[redirects]]
  from = "/api/public/courses.json"
  to = "/.netlify/functions/courses"
  status = 200

# SPA fallback - exclude assets, api, and files with extensions
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  force = false

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.elevateforhumanity.org https://api.stripe.com https://www.google-analytics.com; frame-src https://js.stripe.com https://hooks.stripe.com; base-uri 'self'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
