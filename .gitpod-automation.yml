# Elevate for Humanity - Complete Gitpod Automation
# This file automates the entire development environment setup

image:
  file: .gitpod.Dockerfile

ports:
  - port: 3000
    onOpen: open-preview
    visibility: public
    name: Marketing Site + LMS
    description: Elevate for Humanity - Full Platform
  - port: 5432
    onOpen: ignore
    visibility: private
    name: PostgreSQL
  - port: 54321
    onOpen: ignore
    visibility: private
    name: Supabase Studio

tasks:
  # Task 1: Environment Setup
  - name: ğŸ”§ Environment Setup
    init: |
      echo "ğŸš€ Setting up Elevate for Humanity development environment..."
      
      # Install dependencies
      pnpm install
      
      # Create .env.local if it doesn't exist
      if [ ! -f .env.local ]; then
        echo "ğŸ“ Creating .env.local from example..."
        cp .env.example .env.local
        
        # Generate random secrets
        NEXTAUTH_SECRET=$(openssl rand -base64 32)
        
        # Update .env.local with generated values
        sed -i "s|NEXTAUTH_SECRET=.*|NEXTAUTH_SECRET=$NEXTAUTH_SECRET|g" .env.local
        sed -i "s|NEXT_PUBLIC_SITE_URL=.*|NEXT_PUBLIC_SITE_URL=$(gp url 3000)|g" .env.local
        
        echo "âœ… Environment file created with generated secrets"
      fi
      
      echo "âœ… Dependencies installed"
    
    command: |
      echo ""
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘  ğŸ“ Elevate for Humanity - Development Environment Ready  â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      
      # Try to pull Vercel environment variables
      if [ ! -f .env.local ] || ! grep -q "NEXT_PUBLIC_SUPABASE_URL=https://" .env.local; then
        echo "ğŸ” Attempting to pull Vercel environment variables..."
        
        # Check if vercel CLI is available
        if command -v vercel &> /dev/null; then
          echo "ğŸ“¥ Pulling environment variables from Vercel..."
          vercel env pull .env.local --yes 2>/dev/null || {
            echo "âš ï¸  Could not auto-pull Vercel env vars"
            echo "ğŸ“ Run manually: bash scripts/pull-vercel-env.sh"
          }
        else
          echo "âš ï¸  Vercel CLI not installed"
          echo "ğŸ“ To get Supabase credentials:"
          echo "   1. Run: bash scripts/pull-vercel-env.sh"
          echo "   2. Or manually copy from Vercel dashboard"
        fi
      else
        echo "âœ… Supabase credentials already configured"
      fi
      
      echo ""
      echo "ğŸ“‹ Quick Start Commands:"
      echo "  pnpm dev             - Start development server"
      echo "  pnpm build           - Build for production"
      echo "  node check-database.mjs - Verify Supabase connection"
      echo "  bash scripts/pull-vercel-env.sh - Get Vercel env vars"
      echo ""
      echo "ğŸ“š Documentation:"
      echo "  QUICK_START_GUIDE.md"
      echo "  MASTER_FIX_PLAN.md"
      echo "  WORKFORCE_LMS_COMPARISON.md"
      echo ""
      echo "ğŸŒ Preview URL: $(gp url 3000)"
      echo ""

  # Task 2: Database Setup (if Supabase credentials exist)
  - name: ğŸ—„ï¸ Database Setup
    init: |
      echo "â³ Waiting for environment setup..."
      sleep 5
    
    command: |
      if [ -f .env.local ] && grep -q "NEXT_PUBLIC_SUPABASE_URL=https://" .env.local; then
        echo "ğŸ—„ï¸ Supabase credentials detected, setting up database..."
        
        # Run migrations if they exist
        if [ -d "supabase/migrations" ]; then
          echo "ğŸ“¦ Running database migrations..."
          npm run db:migrate || echo "âš ï¸ Migrations failed or not configured"
        fi
        
        echo "âœ… Database setup complete"
      else
        echo "âš ï¸ Supabase credentials not configured"
        echo "ğŸ“ Add your Supabase credentials to .env.local to enable database features"
      fi

  # Task 3: Development Server
  - name: ğŸš€ Development Server
    init: |
      echo "â³ Waiting for setup to complete..."
      sleep 10
    
    command: |
      echo "ğŸš€ Starting development server..."
      npm run dev

  # Task 4: Helper Scripts
  - name: ğŸ“¦ Helper Scripts
    openMode: split-right
    command: |
      echo ""
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘           ğŸ› ï¸ Helper Commands Available               â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "Database:"
      echo "  npm run db:migrate       - Run migrations"
      echo "  npm run db:seed          - Seed test data"
      echo "  npm run db:reset         - Reset database"
      echo ""
      echo "Development:"
      echo "  npm run dev              - Start dev server"
      echo "  npm run build            - Production build"
      echo "  npm run start            - Start production server"
      echo ""
      echo "Testing:"
      echo "  npm run test             - Run all tests"
      echo "  npm run test:watch       - Watch mode"
      echo "  npm run test:e2e         - End-to-end tests"
      echo ""
      echo "Deployment:"
      echo "  npm run deploy           - Deploy to Vercel"
      echo "  vercel --prod            - Deploy to production"
      echo ""
      echo "Utilities:"
      echo "  npm run lint             - Lint code"
      echo "  npm run format           - Format code"
      echo "  npm run type-check       - Check TypeScript"
      echo ""

vscode:
  extensions:
    # Essential
    - dbaeumer.vscode-eslint
    - esbenp.prettier-vscode
    - bradlc.vscode-tailwindcss
    
    # TypeScript
    - ms-vscode.vscode-typescript-next
    
    # React/Next.js
    - dsznajder.es7-react-js-snippets
    
    # Database
    - mtxr.sqltools
    - mtxr.sqltools-driver-pg
    
    # Git
    - eamodio.gitlens
    
    # Utilities
    - christian-kohler.path-intellisense
    - formulahendry.auto-rename-tag
    - naumovs.color-highlight

github:
  prebuilds:
    master: true
    branches: true
    pullRequests: true
    pullRequestsFromForks: false
    addCheck: true
    addComment: false
    addBadge: true

jetbrains:
  intellij:
    prebuilds:
      version: stable
